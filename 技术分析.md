# Moltbot 技术分析文档

## 目录

1. [项目概述](#1-项目概述)
2. [本地电脑控制机制](#2-本地电脑控制机制)
3. [通讯层架构](#3-通讯层架构)
4. [支持的通讯渠道](#4-支持的通讯渠道)
5. [插件系统](#5-插件系统)
6. [Telegram 通道实现详解](#6-telegram-通道实现详解)
7. [WhatsApp 通道实现详解](#7-whatsapp-通道实现详解)
8. [微信通道开发指南](#8-微信通道开发指南)

---

## 1. 项目概述

### 1.1 整体架构

```
├─ 入口层 (entry.ts, index.ts, program/)
│  └─ CLI 命令处理
│
├─ Gateway 层 (gateway/)
│  ├─ WebSocket 服务器
│  ├─ RPC 方法处理
│  ├─ 事件流管理
│  └─ 会话/状态管理
│
├─ 通道层 (channels/, [telegram, discord, signal, slack, ...])
│  ├─ 监控/接收
│  ├─ 发送/出站
│  └─ 适配器接口
│
├─ Agent 层 (agents/, commands/agent.ts)
│  ├─ AI 运行时 (@mariozechner/pi-*)
│  ├─ 工具系统 (bash, browser, canvas, nodes)
│  ├─ 会话管理
│  └─ 执行审批
│
├─ 插件层 (plugins/, plugin-sdk/)
│  ├─ 动态发现/加载
│  ├─ 工具扩展
│  ├─ 通道扩展
│  ├─ 钩子系统
│  └─ CLI 扩展
│
└─ 配置层 (config/)
   └─ YAML/JSON5 配置管理
```

### 1.2 目录结构

```
src/
├── cli/                    # 命令行接口
├── commands/               # 命令处理 (agent, channels, configure 等)
├── gateway/                # WebSocket 控制平面
├── channels/               # 通讯层适配器
├── agents/                 # AI agent 运行时和工具
├── plugins/                # 插件系统
├── config/                 # 配置管理
├── process/                # 进程执行
├── telegram/               # Telegram 通道实现
├── discord/                # Discord 通道实现
├── whatsapp/               # WhatsApp 通道实现
├── signal/                 # Signal 通道实现
├── slack/                  # Slack 通道实现
├── imessage/               # iMessage 通道实现
└── web/                    # WhatsApp Web (Baileys) 实现
```

### 1.3 入口点

- **主入口**: `src/entry.ts` - 处理 Windows 兼容性、NODE_OPTIONS、CLI profiles
- **核心入口**: `src/index.ts` - CLI 程序构建 (commander.js)、环境变量加载
- **程序构建**: `src/cli/program/build-program.ts`
- **命令注册**: `src/cli/program/command-registry.ts`

---

## 2. 本地电脑控制机制

### 2.1 核心架构流程

```
通讯渠道 (Telegram/Discord/WhatsApp/Signal等)
           ↓
      Gateway (WebSocket 控制平面)
           ↓
      AI Agent (推理引擎)
           ↓
      工具执行 (Bash/Browser/文件操作等)
```

### 2.2 命令执行引擎

#### 基础执行层
**文件**: `src/process/exec.ts`

```typescript
type CommandOptions = {
  timeoutMs: number;
  cwd?: string;
  input?: string;
  env?: NodeJS.ProcessEnv;
  windowsVerbatimArguments?: boolean;
};
```

**关键函数**:
- `runExec()`: 简单的 execFile 包装（超时、缓冲、日志）
- `runCommandWithTimeout()`: 完整的命令执行
  - 支持 stdin/stdout/stderr 流
  - 子进程生成 (spawn)
  - 可继承的 stdio (TTY 交互)
  - 超时管理和进程 kill

#### 高级 Bash 工具
**文件**: `src/agents/bash-tools.exec.ts`

```typescript
type ExecToolDefaults = {
  host?: ExecHost;              // 本地/节点主机
  security?: ExecSecurity;       // 安全级别
  ask?: ExecAsk;                 // 批准策略
  sandbox?: BashSandboxConfig;   // 沙箱配置
  elevated?: ExecElevatedDefaults; // 提权设置
  node?: string;                 // 远程节点
  agentId?: string;              // 关联的 agent
  timeoutSec?: number;
};
```

**核心能力**:
- 支持 PTY (伪终端) 和 non-PTY 执行
- **审批系统**: 敏感命令需要批准
- **安全列表**: 已批准的命令缓存
- **后台执行**: 异步命令跟踪
- **沙箱支持**: Docker/system jail
- **进程会话管理**: `src/agents/bash-process-registry.ts`

### 2.3 安全机制

#### 审批系统
**文件**: `src/infra/exec-approvals.ts`, `src/gateway/exec-approval-manager.ts`

- **权限列表**: 已批准的命令缓存
- **审批流程**: 危险操作需要通过 Gateway 获得明确批准
- **执行审批管理器**: 集中管理敏感命令的人类批准

---

## 3. 通讯层架构

### 3.1 Gateway WebSocket 控制平面

**核心文件**: `src/gateway/server.impl.ts`

```
通讯渠道 (WhatsApp/Telegram/Slack/Discord/Signal/iMessage/etc)
           ↓
      Gateway (WS 控制平面)
           ↓
    ┌──────┴──────┬──────────┬──────────┐
    ↓             ↓          ↓          ↓
  macOS App     CLI        WebChat    iOS/Android 节点
```

### 3.2 RPC 方法分类

**文件**: `src/gateway/server-methods.ts`

```typescript
// 只读方法
const READ_METHODS = new Set([
  "health", "channels.status", "status", "agents.list",
  "chat.history", "sessions.list", "cron.list", ...
]);

// 写入方法
const WRITE_METHODS = new Set([
  "send", "agent", "wake", "talk.mode", "chat.send",
  "browser.request", ...
]);

// 审批方法
const APPROVAL_METHODS = new Set([
  "exec.approval.request", "exec.approval.resolve"
]);
```

### 3.3 WS 协议

- **握手**: 客户端发送 `connect` 请求
- **认证**: 可选 token (`CLAWDBOT_GATEWAY_TOKEN`)
- **请求/响应**: `{type:"req", id, method, params} → {type:"res", id, ok, payload|error}`
- **事件流**: `{type:"event", event, payload, seq?, stateVersion?}`

### 3.4 消息流程

#### 入站流程
```
通道 (如 Telegram)
  ↓
Channel Monitor (src/telegram/monitor.ts 等)
  ↓
Gateway (server-chat.ts 或 server-methods/chat.ts)
  ↓
Agent 触发 + 会话管理
  ↓
AI 响应 + 工具调用
  ↓
Agent 流事件
```

#### 出站流程
```
Agent 响应 / send 命令
  ↓
Gateway (send.ts)
  ↓
通道适配器 (ChannelOutboundAdapter)
  ↓
通道特定实现 (如 discord/send.ts)
  ↓
实际发送到通道
```

---

## 4. 支持的通讯渠道

### 4.1 通道注册表

**文件**: `src/channels/registry.ts`

```typescript
const CHAT_CHANNEL_ORDER = [
  "telegram",     // Telegram Bot API (grammY)
  "whatsapp",     // WhatsApp Web (Baileys)
  "discord",      // Discord (discord.js)
  "googlechat",   // Google Chat API
  "slack",        // Slack (Bolt)
  "signal",       // Signal (signal-cli)
  "imessage",     // iMessage (imsg)
];
```

### 4.2 扩展通道（插件）

- BlueBubbles
- Microsoft Teams
- Matrix
- Zalo
- Zalo Personal
- WebChat

### 4.3 通道对比

| 特性 | Telegram | WhatsApp | Discord | Signal |
|------|----------|---------|---------|--------|
| **监听模式** | 轮询/Webhook | Baileys WebSocket | Gateway | signal-cli |
| **发送模式** | 直接 API | Gateway 代理 | 直接 API | 直接 API |
| **多账户** | ✓ | ✓ | ✓ | ✓ |
| **消息分块** | Markdown→HTML | 纯文本 | Markdown | 纯文本 |
| **群组支持** | ✓（论坛主题） | ✓ | ✓（频道/线程） | ✓ |
| **反应** | ✓ | ✓ | ✓ | ✓ |
| **认证** | Bot Token | QR码 | Bot Token | 手机号 |

---

## 5. 插件系统

### 5.1 插件注册表

**文件**: `src/plugins/registry.ts`

```typescript
export type PluginRegistry = {
  plugins: PluginRecord[];
  tools: PluginToolRegistration[];
  hooks: PluginHookRegistration[];
  channels: PluginChannelRegistration[];
  providers: PluginProviderRegistration[];
  gatewayHandlers: GatewayRequestHandlers;
  httpHandlers: PluginHttpRegistration[];
  httpRoutes: PluginHttpRouteRegistration[];
  cliRegistrars: PluginCliRegistration[];
  services: PluginServiceRegistration[];
  commands: PluginCommandRegistration[];
};
```

### 5.2 插件可注册的内容

1. **工具** (AgentTools): 代理可调用的工具
2. **通道**: 新的消息传递渠道
3. **钩子**: 特定事件的回调
4. **HTTP 路由**: 自定义 API 端点
5. **CLI 命令**: 新的 CLI 子命令
6. **Gateway 方法**: 新的 RPC 方法
7. **服务**: 长寿命的后台服务
8. **提供者**: 如 LLM 提供者

### 5.3 插件发现和加载

**文件**: `src/plugins/discovery.ts`, `src/plugins/loader.ts`

- 搜索 `node_modules/@moltbot-plugins/*`
- 搜索工作空间目录中的本地插件
- 动态导入插件代码
- 验证清单
- 初始化插件

---

## 6. Telegram 通道实现详解

### 6.1 目录结构

```
src/telegram/
├── monitor.ts              # 消息监听器（轮询/Webhook）
├── send.ts                 # 发送器实现
├── bot.ts                  # Grammy 机器人初始化
├── bot-handlers.ts         # 事件处理程序
├── bot-message.ts          # 消息处理流程
├── bot-message-dispatch.ts # 消息分发
├── format.ts               # Markdown to HTML 格式化
├── accounts.ts             # 账户管理（多账户支持）
└── download.ts             # 媒体下载

src/channels/plugins/
├── outbound/telegram.ts     # 出站适配器
├── normalize/telegram.ts    # 目标标准化
├── onboarding/telegram.ts   # 引导流程
└── actions/telegram.ts      # 消息动作（React/Delete/Edit）
```

### 6.2 监听器实现

**文件**: `src/telegram/monitor.ts`

```typescript
export async function monitorTelegramProvider(opts: MonitorTelegramOpts = {}) {
  // 读取上次的更新偏移量
  let lastUpdateId = await readTelegramUpdateOffset({ accountId });

  const bot = createTelegramBot({
    token,
    updateOffset: { lastUpdateId, onUpdateId: persistUpdateId },
  });

  if (opts.useWebhook) {
    // Webhook 模式
    await startTelegramWebhook({...});
    return;
  }

  // 轮询模式：使用 grammyjs/runner 处理并发更新
  const runner = run(bot, createTelegramRunnerOptions(cfg));
  await runner.task();
}
```

**关键特性**:
- 更新偏移持久化（避免重复处理）
- Webhook vs 轮询模式
- 并发处理（grammy/runner）
- 自动重试可恢复的网络错误

### 6.3 发送器实现

**文件**: `src/telegram/send.ts`

- 支持文本、图片、视频、音频、文档、贴纸
- Markdown → HTML 转换
- 线程/回复支持
- 内联按钮
- 自动重试

### 6.4 配置类型

**文件**: `src/config/types.telegram.ts`

```typescript
export type TelegramAccountConfig = {
  name?: string;
  botToken?: string;
  dmPolicy?: DmPolicy;
  allowFrom?: Array<string | number>;
  groupPolicy?: GroupPolicy;
  textChunkLimit?: number;
  webhookUrl?: string;
  actions?: TelegramActionConfig;
  // ... 更多配置
};
```

---

## 7. WhatsApp 通道实现详解

### 7.1 目录结构

```
src/web/
├── outbound.ts              # 发送器
├── inbound/monitor.ts       # 监听器
├── session.ts               # Baileys 会话管理
├── media.ts                 # 媒体处理
└── accounts.js              # 账户和认证

src/whatsapp/
└── normalize.ts             # JID 和电话号码标准化

src/channels/plugins/
├── outbound/whatsapp.ts     # 出站适配器
├── normalize/whatsapp.ts    # 目标标准化
├── onboarding/whatsapp.ts   # 引导流程
├── whatsapp-heartbeat.ts    # 心跳检测
└── agent-tools/whatsapp-login.ts  # 登录工具
```

### 7.2 监听器实现

**文件**: `src/web/inbound/monitor.ts`

```typescript
export async function monitorWebInbox(options) {
  // 创建 Baileys WhatsApp 会话
  const sock = await createWaSocket(false, options.verbose, {
    authDir: options.authDir,
  });
  await waitForWaConnection(sock);

  // 消息防抖处理
  const debouncer = createInboundDebouncer<WebInboundMessage>({...});

  sock.ev.on("messages.upsert", handleMessagesUpsert);
}
```

**关键特性**:
- Baileys 集成（@whiskeysockets/baileys）
- 消息防抖（合并快速连续消息）
- 自动已读回执
- 群组元数据缓存

### 7.3 发送器实现

**文件**: `src/web/outbound.ts`

- 通过 Gateway 代理发送
- 支持文本、媒体、投票
- 发送"正在输入"指示
- 媒体类型自动识别

### 7.4 配置类型

**文件**: `src/config/types.whatsapp.ts`

```typescript
export type WhatsAppConfig = {
  sendReadReceipts?: boolean;
  dmPolicy?: DmPolicy;
  allowFrom?: string[];
  groupPolicy?: GroupPolicy;
  debounceMs?: number;
  ackReaction?: { emoji?: string; };
  // ... 更多配置
};
```

---

## 8. 微信通道开发指南

### 8.1 插件结构模板

```
moltbot-plugin-wechat/
├── package.json
├── manifest.json
├── tsconfig.json
└── src/
    ├── index.ts              # 插件入口
    ├── channel.ts            # 通道插件定义
    ├── config.ts             # 配置类型和处理
    ├── monitor.ts            # 消息监听器
    ├── send.ts               # 消息发送器
    ├── outbound.ts           # 出站适配器
    ├── normalize.ts          # ID/号码标准化
    ├── session.ts            # Wechaty 会话管理
    └── types.ts              # 类型定义
```

### 8.2 核心接口实现

#### ChannelPlugin 接口

**文件**: `src/channels/plugins/types.plugin.ts`

```typescript
export type ChannelPlugin<ResolvedAccount = any> = {
  id: ChannelId;                    // "wechat"
  meta: ChannelMeta;                // 元信息
  capabilities: ChannelCapabilities; // 能力声明
  config: ChannelConfigAdapter<ResolvedAccount>;
  outbound?: ChannelOutboundAdapter;
  gateway?: ChannelGatewayAdapter<ResolvedAccount>;
  onboarding?: ChannelOnboardingAdapter;
  status?: ChannelStatusAdapter<ResolvedAccount>;
  // ...
};
```

#### ChannelOutboundAdapter 接口

**文件**: `src/channels/plugins/types.adapters.ts`

```typescript
export type ChannelOutboundAdapter = {
  deliveryMode: "direct" | "gateway" | "hybrid";
  chunker?: (text: string, limit: number) => string[];
  textChunkLimit?: number;
  sendText?: (ctx: ChannelOutboundContext) => Promise<OutboundDeliveryResult>;
  sendMedia?: (ctx: ChannelOutboundContext) => Promise<OutboundDeliveryResult>;
};
```

#### ChannelGatewayAdapter 接口

```typescript
export type ChannelGatewayAdapter<ResolvedAccount = unknown> = {
  startAccount?: (ctx: ChannelGatewayContext<ResolvedAccount>) => Promise<unknown>;
  stopAccount?: (ctx: ChannelGatewayContext<ResolvedAccount>) => Promise<void>;
  loginWithQrStart?: (params) => Promise<ChannelLoginWithQrStartResult>;
  loginWithQrWait?: (params) => Promise<ChannelLoginWithQrWaitResult>;
  logoutAccount?: (ctx) => Promise<ChannelLogoutResult>;
};
```

### 8.3 推荐的微信桥接库

| 库名 | 协议 | 稳定性 | 说明 |
|------|------|--------|------|
| **wechaty** | 多种 | 高 | 最流行，支持多种 Puppet |
| **wechaty-puppet-wechat** | Web | 中 | 免费，需扫码 |
| **wechaty-puppet-padlocal** | iPad | 高 | 付费，最稳定 |
| **wechaty-puppet-xp** | Windows | 中 | 需要 Windows |

### 8.4 ⚠️ 微信接入风险提示

1. **账号风险**: 微信对第三方客户端有严格限制，可能导致账号封禁
2. **协议选择**:
   - Web 协议：需要扫码登录，稳定性一般
   - iPad/Mac 协议：更稳定但需要付费服务
3. **建议**: 使用小号测试，不要用主要账号

---

## 附录

### A. 关键文件索引

| 功能 | 文件路径 |
|------|----------|
| 程序入口 | `src/entry.ts`, `src/index.ts` |
| 命令执行 | `src/process/exec.ts` |
| Bash 工具 | `src/agents/bash-tools.exec.ts` |
| Gateway 服务 | `src/gateway/server.impl.ts` |
| 通道注册 | `src/channels/registry.ts` |
| 插件系统 | `src/plugins/registry.ts` |
| 插件加载 | `src/plugins/loader.ts` |
| 通道插件类型 | `src/channels/plugins/types.plugin.ts` |
| 适配器类型 | `src/channels/plugins/types.adapters.ts` |

### B. 配置文件位置

- 主配置: `~/.clawdbot/config.json5`
- Telegram 认证: `~/.clawdbot/telegram/`
- WhatsApp 认证: `~/.clawdbot/web/` (Baileys auth)

### C. 相关文档

- 通道配置指南: `docs/channels/`
- 插件 SDK: `src/plugin-sdk/index.ts`
