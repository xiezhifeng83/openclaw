# OpenClaw 架构设计与流程图

> 本文档包含系统架构设计图、业务流程图和程序流程图

---

## 目录

1. [系统架构图](#1-系统架构图)
2. [业务流程图](#2-业务流程图)
3. [程序流程图](#3-程序流程图)
4. [数据流图](#4-数据流图)
5. [状态机图](#5-状态机图)
6. [时序图](#6-时序图)

---

## 1. 系统架构图

### 1.1 整体系统架构

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                    用户层 (Users)                                    │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                      │
│   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐             │
│   │ WhatsApp │  │ Telegram │  │ Discord  │  │  Slack   │  │  其他    │  <-- 通讯用户 │
│   │   用户   │  │   用户   │  │   用户   │  │   用户   │  │  渠道   │              │
│   └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘             │
│        │             │             │             │             │                    │
│        └─────────────┴─────────────┼─────────────┴─────────────┘                    │
│                                    │                                                 │
└────────────────────────────────────┼─────────────────────────────────────────────────┘
                                     │
┌────────────────────────────────────┼─────────────────────────────────────────────────┐
│                              渠道集成层 (Channels)                                    │
├────────────────────────────────────┼─────────────────────────────────────────────────┤
│                                    │                                                 │
│   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │
│   │   Baileys    │  │   grammY     │  │ discord.js   │  │  Slack Bolt  │            │
│   │  (WhatsApp)  │  │  (Telegram)  │  │  (Discord)   │  │   (Slack)    │            │
│   └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘            │
│          │                 │                 │                 │                    │
│          └─────────────────┴─────────────────┴─────────────────┘                    │
│                                    │                                                 │
│                         ┌──────────▼──────────┐                                     │
│                         │    渠道适配器层      │                                     │
│                         │  Channel Adapters   │                                     │
│                         └──────────┬──────────┘                                     │
│                                    │                                                 │
└────────────────────────────────────┼─────────────────────────────────────────────────┘
                                     │
┌────────────────────────────────────┼─────────────────────────────────────────────────┐
│                               网关层 (Gateway)                                        │
├────────────────────────────────────┼─────────────────────────────────────────────────┤
│                                    │                                                 │
│   ┌────────────────────────────────▼────────────────────────────────────┐           │
│   │                        Gateway Server                                │           │
│   │                      WebSocket :18789 | HTTP :18790                  │           │
│   └────────────────────────────────┬────────────────────────────────────┘           │
│                                    │                                                 │
│   ┌─────────────┬──────────────────┼──────────────────┬─────────────┐               │
│   │             │                  │                  │             │               │
│   ▼             ▼                  ▼                  ▼             ▼               │
│ ┌─────────┐ ┌─────────┐ ┌──────────────────┐ ┌─────────┐ ┌─────────────┐           │
│ │  Auth   │ │ Router  │ │  RPC Methods     │ │Broadcast│ │   Cron      │           │
│ │ Module  │ │ Module  │ │  Handler         │ │ Module  │ │  Service    │           │
│ └─────────┘ └─────────┘ └──────────────────┘ └─────────┘ └─────────────┘           │
│                                    │                                                 │
└────────────────────────────────────┼─────────────────────────────────────────────────┘
                                     │
┌────────────────────────────────────┼─────────────────────────────────────────────────┐
│                              核心服务层 (Core Services)                               │
├────────────────────────────────────┼─────────────────────────────────────────────────┤
│                                    │                                                 │
│   ┌───────────┬────────────────────┼────────────────────┬───────────┐               │
│   │           │                    │                    │           │               │
│   ▼           ▼                    ▼                    ▼           ▼               │
│ ┌─────────┐ ┌─────────┐ ┌──────────────────┐ ┌─────────┐ ┌─────────────┐           │
│ │ Session │ │ Config  │ │   Agent Engine   │ │ Plugin  │ │   Memory    │           │
│ │ Manager │ │ Manager │ │ (Pi AI Runtime)  │ │ System  │ │   System    │           │
│ └─────────┘ └─────────┘ └──────────────────┘ └─────────┘ └─────────────┘           │
│                                    │                                                 │
│                         ┌──────────▼──────────┐                                     │
│                         │     Tool System     │                                     │
│                         │  Bash|Browser|File  │                                     │
│                         └─────────────────────┘                                     │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                     │
┌────────────────────────────────────┼─────────────────────────────────────────────────┐
│                               AI模型层 (AI Models)                                    │
├────────────────────────────────────┼─────────────────────────────────────────────────┤
│                                    │                                                 │
│   ┌───────────┬────────────────────┼────────────────────┬───────────┐               │
│   │           │                    │                    │           │               │
│   ▼           ▼                    ▼                    ▼           ▼               │
│ ┌─────────┐ ┌─────────┐ ┌──────────────────┐ ┌─────────┐ ┌─────────────┐           │
│ │Anthropic│ │ OpenAI  │ │     Gemini       │ │  Qwen   │ │   Ollama    │           │
│ │ Claude  │ │   GPT   │ │                  │ │         │ │   (Local)   │           │
│ └─────────┘ └─────────┘ └──────────────────┘ └─────────┘ └─────────────┘           │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                     │
┌────────────────────────────────────┼─────────────────────────────────────────────────┐
│                               存储层 (Storage)                                        │
├────────────────────────────────────┼─────────────────────────────────────────────────┤
│                                    │                                                 │
│   ┌───────────┬────────────────────┼────────────────────┬───────────┐               │
│   │           │                    │                    │           │               │
│   ▼           ▼                    ▼                    ▼           ▼               │
│ ┌─────────┐ ┌─────────┐ ┌──────────────────┐ ┌─────────┐ ┌─────────────┐           │
│ │Sessions │ │ Config  │ │   Credentials    │ │ Logs    │ │ Vector DB   │           │
│ │ (JSONL) │ │ (JSON5) │ │    (Secure)      │ │         │ │ (sqlite-vec)│           │
│ └─────────┘ └─────────┘ └──────────────────┘ └─────────┘ └─────────────┘           │
│                                                                                      │
│   文件路径: ~/.openclaw/                                                             │
│   ├── config.json                                                                   │
│   ├── credentials/                                                                  │
│   ├── state/sessions/                                                               │
│   └── logs/                                                                         │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
                                     │
┌────────────────────────────────────┼─────────────────────────────────────────────────┐
│                              客户端层 (Clients)                                       │
├────────────────────────────────────┼─────────────────────────────────────────────────┤
│                                    │                                                 │
│   ┌───────────┬────────────────────┼────────────────────┬───────────┐               │
│   │           │                    │                    │           │               │
│   ▼           ▼                    ▼                    ▼           ▼               │
│ ┌─────────┐ ┌─────────┐ ┌──────────────────┐ ┌─────────┐ ┌─────────────┐           │
│ │ Web UI  │ │   CLI   │ │     macOS        │ │   iOS   │ │   Android   │           │
│ │(Lit/Vite)│ │(Commander)│ │   (Swift)        │ │ (Swift) │ │  (Kotlin)   │           │
│ └─────────┘ └─────────┘ └──────────────────┘ └─────────┘ └─────────────┘           │
│                                                                                      │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 Gateway 详细架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Gateway Server                                      │
│                           (src/gateway/server.ts)                                │
└────────────────────────────────────┬────────────────────────────────────────────┘
                                     │
         ┌───────────────────────────┼───────────────────────────┐
         │                           │                           │
         ▼                           ▼                           ▼
┌─────────────────┐        ┌─────────────────┐        ┌─────────────────┐
│   HTTP Server   │        │ WebSocket Server│        │   Broadcaster   │
│ (server-http.ts)│        │  (server-ws.ts) │        │(server-broadcast)│
├─────────────────┤        ├─────────────────┤        ├─────────────────┤
│ Endpoints:      │        │ Protocol:       │        │ Features:       │
│ • /hooks/*      │        │ • JSON-RPC      │        │ • Event Filter  │
│ • /tools/*      │        │ • Frame-based   │        │ • Scope Guards  │
│ • /openai/*     │        │ • Bi-directional│        │ • Buffer Mgmt   │
│ • /slack/*      │        │                 │        │ • State Version │
│ • /control-ui/* │        │ Lifecycle:      │        │                 │
│ • /canvas/*     │        │ • Connect       │        │ Events:         │
│                 │        │ • Challenge     │        │ • chat          │
│ Middleware:     │        │ • Hello         │        │ • agent         │
│ • Auth          │        │ • Request/Resp  │        │ • presence      │
│ • CORS          │        │ • Events        │        │ • cron          │
│ • Rate Limit    │        │ • Heartbeat     │        │ • device.*      │
│                 │        │ • Disconnect    │        │ • exec.*        │
└────────┬────────┘        └────────┬────────┘        └────────┬────────┘
         │                          │                          │
         └──────────────────────────┼──────────────────────────┘
                                    │
                     ┌──────────────▼──────────────┐
                     │      RPC Methods Router     │
                     │   (gateway/server-methods/) │
                     └──────────────┬──────────────┘
                                    │
    ┌───────────────┬───────────────┼───────────────┬───────────────┐
    │               │               │               │               │
    ▼               ▼               ▼               ▼               ▼
┌─────────┐   ┌─────────┐   ┌─────────────┐  ┌─────────┐   ┌─────────────┐
│ chat.*  │   │ agent.* │   │ channels.*  │  │config.* │   │   cron.*    │
├─────────┤   ├─────────┤   ├─────────────┤  ├─────────┤   ├─────────────┤
│ send    │   │ exec    │   │ status      │  │ get     │   │ jobs        │
│ history │   │ list    │   │ login       │  │ set     │   │ run         │
│ abort   │   │ skills  │   │ logout      │  │ apply   │   │ add         │
│ inject  │   │         │   │ config      │  │ schema  │   │ remove      │
└─────────┘   └─────────┘   └─────────────┘  └─────────┘   └─────────────┘
    │               │               │               │               │
    ▼               ▼               ▼               ▼               ▼
┌─────────┐   ┌─────────┐   ┌─────────────┐  ┌─────────┐   ┌─────────────┐
│sessions │   │ nodes.* │   │ devices.*   │  │ logs.*  │   │exec.approvals│
├─────────┤   ├─────────┤   ├─────────────┤  ├─────────┤   ├─────────────┤
│ list    │   │ list    │   │ pair.*      │  │ tail    │   │ request     │
│ patch   │   │         │   │ token.*     │  │         │   │ resolve     │
│ delete  │   │         │   │ list        │  │         │   │ list        │
└─────────┘   └─────────┘   └─────────────┘  └─────────┘   └─────────────┘
```

### 1.3 Agent 引擎架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            Agent Engine (src/agents/)                            │
└────────────────────────────────────┬────────────────────────────────────────────┘
                                     │
         ┌───────────────────────────┼───────────────────────────┐
         │                           │                           │
         ▼                           ▼                           ▼
┌─────────────────┐        ┌─────────────────┐        ┌─────────────────┐
│  Model Manager  │        │  Prompt Builder │        │  Tool Registry  │
│   (model-*.ts)  │        │(system-prompt.ts)│        │  (bash-tools)   │
├─────────────────┤        ├─────────────────┤        ├─────────────────┤
│ • Model Select  │        │ • System Prompt │        │ • Tool Schema   │
│ • Fallback      │        │ • User Prompt   │        │ • Tool Execute  │
│ • Streaming     │        │ • Context Merge │        │ • Policy Check  │
│ • Token Count   │        │ • History Trim  │        │ • Result Format │
└────────┬────────┘        └────────┬────────┘        └────────┬────────┘
         │                          │                          │
         └──────────────────────────┼──────────────────────────┘
                                    │
                     ┌──────────────▼──────────────┐
                     │      Pi Agent Runtime       │
                     │   (@mariozechner/pi-*)      │
                     ├─────────────────────────────┤
                     │ • Block Streaming           │
                     │ • Tool Call Orchestration   │
                     │ • Thinking Mode             │
                     │ • Error Recovery            │
                     │ • Abort Handling            │
                     └──────────────┬──────────────┘
                                    │
    ┌───────────────┬───────────────┼───────────────┬───────────────┐
    │               │               │               │               │
    ▼               ▼               ▼               ▼               ▼
┌─────────┐   ┌─────────┐   ┌─────────────┐  ┌─────────┐   ┌─────────────┐
│ Bash    │   │ Browser │   │    File     │  │   Web   │   │   Custom    │
│ Tools   │   │ Tools   │   │   Tools     │  │  Tools  │   │   Plugins   │
├─────────┤   ├─────────┤   ├─────────────┤  ├─────────┤   ├─────────────┤
│ • exec  │   │ • browse│   │ • read      │  │ • fetch │   │ • skill-*   │
│ • shell │   │ • click │   │ • write     │  │ • search│   │ • mcp-*     │
│ • script│   │ • type  │   │ • edit      │  │ • scrape│   │ • ext-*     │
└─────────┘   └─────────┘   └─────────────┘  └─────────┘   └─────────────┘

                                    │
                                    ▼
                     ┌──────────────────────────────┐
                     │        Skills System         │
                     │       (agents/skills/)       │
                     ├──────────────────────────────┤
                     │ • Skill Discovery            │
                     │ • Skill Loading              │
                     │ • API Key Injection          │
                     │ • Enable/Disable             │
                     └──────────────────────────────┘
```

### 1.4 前端架构

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           Control UI (ui/src/)                                   │
│                          Lit + Vite + Web Components                             │
└────────────────────────────────────┬────────────────────────────────────────────┘
                                     │
┌────────────────────────────────────▼────────────────────────────────────────────┐
│                              App Shell (app.ts)                                  │
│                           @customElement("openclaw-app")                         │
├──────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌────────────────────────────────────────────────────────────────────────────┐ │
│  │                              Topbar                                         │ │
│  │  ┌──────────────┐  ┌────────────────────────────┐  ┌──────────────────┐   │ │
│  │  │    Logo      │  │      Connection Status     │  │  Theme Toggle    │   │ │
│  │  └──────────────┘  └────────────────────────────┘  └──────────────────┘   │ │
│  └────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                  │
│  ┌──────────────────┐  ┌──────────────────────────────────────────────────────┐ │
│  │                  │  │                                                      │ │
│  │      Nav         │  │                      Content                         │ │
│  │                  │  │                                                      │ │
│  │  ┌────────────┐  │  │  ┌────────────────────────────────────────────────┐ │ │
│  │  │   Chat     │  │  │  │                                                │ │ │
│  │  ├────────────┤  │  │  │              Active View                       │ │ │
│  │  │  Control   │  │  │  │                                                │ │ │
│  │  │  • Overview│  │  │  │  (chat | overview | channels | sessions |     │ │ │
│  │  │  • Channels│  │  │  │   cron | skills | nodes | config | debug |    │ │ │
│  │  │  • Instance│  │  │  │   logs | instances)                           │ │ │
│  │  │  • Sessions│  │  │  │                                                │ │ │
│  │  │  • Cron    │  │  │  └────────────────────────────────────────────────┘ │ │
│  │  ├────────────┤  │  │                                                      │ │
│  │  │   Agent    │  │  │  ┌────────────────────────────────────────────────┐ │ │
│  │  │  • Skills  │  │  │  │              Sidebar (Chat Only)               │ │ │
│  │  │  • Nodes   │  │  │  │                                                │ │ │
│  │  ├────────────┤  │  │  │              Tool Output Panel                 │ │ │
│  │  │  Settings  │  │  │  │                                                │ │ │
│  │  │  • Config  │  │  │  └────────────────────────────────────────────────┘ │ │
│  │  │  • Debug   │  │  │                                                      │ │
│  │  │  • Logs    │  │  │                                                      │ │
│  │  └────────────┘  │  │                                                      │ │
│  │                  │  │                                                      │ │
│  └──────────────────┘  └──────────────────────────────────────────────────────┘ │
│                                                                                  │
└──────────────────────────────────────────────────────────────────────────────────┘
                                     │
         ┌───────────────────────────┼───────────────────────────┐
         │                           │                           │
         ▼                           ▼                           ▼
┌─────────────────┐        ┌─────────────────┐        ┌─────────────────┐
│  State Manager  │        │   Controllers   │        │ Gateway Client  │
│   (@state)      │        │  (controllers/) │        │  (gateway.ts)   │
├─────────────────┤        ├─────────────────┤        ├─────────────────┤
│ • connected     │        │ • chat.ts       │        │ • WebSocket     │
│ • tab           │        │ • config.ts     │        │ • Device Auth   │
│ • chatMessages  │        │ • channels.ts   │        │ • Request/Resp  │
│ • settings      │        │ • sessions.ts   │        │ • Event Stream  │
│ • ...200+ props │        │ • cron.ts       │        │ • Reconnect     │
└─────────────────┘        │ • ...           │        └─────────────────┘
                           └─────────────────┘
```

---

## 2. 业务流程图

### 2.1 消息处理完整流程

```mermaid
flowchart TB
    subgraph Input["📥 消息入站"]
        A1[WhatsApp消息] --> B
        A2[Telegram消息] --> B
        A3[Discord消息] --> B
        A4[Slack消息] --> B
        A5[其他渠道消息] --> B
    end

    B[渠道适配器<br/>提取元数据]
    B --> C{消息类型判断}

    C -->|私聊 DM| D1[DM流程]
    C -->|群组消息| D2[群组流程]
    C -->|频道消息| D3[频道流程]

    subgraph DMFlow["🔒 DM处理流程"]
        D1 --> E1{DM Policy?}
        E1 -->|pairing| F1[检查配对状态]
        E1 -->|allowlist| F2[检查允许列表]
        E1 -->|open| G1[直接处理]

        F1 -->|已配对| G1
        F1 -->|未配对| F1A[发送配对码]
        F1A --> F1B[等待用户确认]

        F2 -->|在列表| G1
        F2 -->|不在列表| F2A[拒绝消息]
    end

    subgraph GroupFlow["👥 群组处理流程"]
        D2 --> E2{Group Policy?}
        E2 -->|mention-gating| G2A{检查@提及}
        E2 -->|allowlist| G2B[检查发送者]
        E2 -->|open| G2C[直接处理]
        E2 -->|disabled| G2D[忽略消息]

        G2A -->|有@机器人| G2C
        G2A -->|无@| G2D

        G2B -->|在列表| G2C
        G2B -->|不在列表| G2D
    end

    G1 --> H
    G2C --> H

    H[构造Session Key<br/>channel:chatType:peerId]
    H --> I[加载会话状态]

    I --> J{会话存在?}
    J -->|是| K[加载历史上下文]
    J -->|否| K1[创建新会话]
    K1 --> K

    K --> L[路由解析<br/>选择Agent]

    L --> M[Agent执行引擎]

    subgraph AgentEngine["🤖 Agent处理"]
        M --> M1[构建系统提示]
        M1 --> M2[合并历史上下文]
        M2 --> M3[准备工具集]
        M3 --> M4[调用AI模型]

        M4 --> M5{响应类型}
        M5 -->|thinking| M6[处理思考块]
        M5 -->|text| M7[处理文本块]
        M5 -->|tool_use| M8[执行工具调用]

        M6 --> M9[广播事件]
        M7 --> M9
        M8 --> M8A[工具执行]
        M8A --> M8B[工具结果]
        M8B --> M4

        M9 --> M10{完成?}
        M10 -->|否| M4
        M10 -->|是| M11[最终响应]
    end

    M11 --> N[响应后处理]

    subgraph PostProcess["📤 响应处理"]
        N --> N1[应用responsePrefix]
        N1 --> N2{超过chunkLimit?}
        N2 -->|是| N3[分块处理]
        N2 -->|否| N4[直接发送]
        N3 --> N4
        N4 --> N5[格式化为渠道格式]
    end

    N5 --> O[发送响应]

    subgraph Output["✅ 消息出站"]
        O --> O1[WhatsApp]
        O --> O2[Telegram]
        O --> O3[Discord]
        O --> O4[Slack]
        O --> O5[其他渠道]
    end

    O --> P[更新会话状态]
    P --> Q[保存到存储]
    Q --> R((完成))
```

### 2.2 用户认证流程

```mermaid
flowchart TB
    A[客户端发起连接] --> B{连接类型}

    B -->|WebSocket| C[WS握手]
    B -->|HTTP| D[HTTP请求]

    C --> E[等待Challenge事件]
    E --> F[获取Nonce]
    F --> G{认证方式}

    D --> G

    G -->|本地连接| H1[检查Loopback]
    G -->|Tailscale| H2[检查TS头]
    G -->|Token| H3[Token验证]
    G -->|Password| H4[密码验证]
    G -->|Device| H5[设备签名]

    H1 -->|是Loopback| I[免认证通过]
    H1 -->|不是| H2

    H2 --> H2A[提取TS用户]
    H2A --> H2B[Whois验证]
    H2B -->|成功| I
    H2B -->|失败| H3

    H3 --> H3A[timingSafeEqual]
    H3A -->|匹配| I
    H3A -->|不匹配| H4

    H4 --> H4A[timingSafeEqual]
    H4A -->|匹配| I
    H4A -->|不匹配| J[认证失败]

    H5 --> H5A[验证设备签名]
    H5A --> H5B{签名有效?}
    H5B -->|是| H5C{Token有效?}
    H5B -->|否| J

    H5C -->|是| I
    H5C -->|否| H5D[签发新Token]
    H5D --> I

    I --> K[授权检查]

    K --> L{检查Scopes}
    L -->|admin| M1[完全权限]
    L -->|read| M2[只读权限]
    L -->|write| M3[读写权限]
    L -->|approvals| M4[批准权限]
    L -->|pairing| M5[配对权限]

    M1 --> N[建立连接]
    M2 --> N
    M3 --> N
    M4 --> N
    M5 --> N

    J --> O[返回401]
    O --> P((结束))

    N --> Q[开始通信]
    Q --> R((连接就绪))
```

### 2.3 配置管理流程

```mermaid
flowchart TB
    subgraph LoadConfig["📖 加载配置"]
        A[启动/请求] --> B[读取config.json]
        B --> C[JSON5解析]
        C --> D[Schema验证]
        D -->|有效| E[构建配置对象]
        D -->|无效| F[报告错误]
        E --> G[应用默认值]
        G --> H[返回配置快照]
    end

    subgraph EditConfig["✏️ 编辑配置"]
        I[用户修改] --> J{编辑模式}
        J -->|表单| K1[更新表单字段]
        J -->|原始JSON| K2[更新原始文本]

        K1 --> L[实时验证]
        K2 --> L

        L -->|有效| M[标记dirty]
        L -->|无效| N[显示错误]
    end

    subgraph SaveConfig["💾 保存配置"]
        O[保存请求] --> P[序列化配置]
        P --> Q[验证Hash一致性]
        Q -->|一致| R[写入文件]
        Q -->|不一致| S[冲突处理]

        R --> T[更新快照]
        S --> U[合并或覆盖]
        U --> R
    end

    subgraph ApplyConfig["⚡ 应用配置"]
        V[应用请求] --> W[触发重启哨兵]
        W --> X[Gateway重启]
        X --> Y[重新加载配置]
        Y --> Z[WebSocket断开]
        Z --> AA[客户端重连]
    end

    H --> I
    M --> O
    T --> V
```

---

## 3. 程序流程图

### 3.1 Gateway 启动流程

```mermaid
flowchart TB
    A[启动命令<br/>openclaw gateway] --> B[解析CLI参数]
    B --> C[加载环境变量]
    C --> D[加载配置文件]

    D --> E{配置有效?}
    E -->|否| F[显示错误<br/>退出]
    E -->|是| G[初始化日志系统]

    G --> H[初始化存储路径]
    H --> I[加载凭证]

    I --> J[初始化Gateway Server]

    subgraph ServerInit["服务器初始化"]
        J --> J1[创建HTTP Server]
        J1 --> J2[创建WebSocket Server]
        J2 --> J3[初始化Broadcaster]
        J3 --> J4[注册RPC Methods]
        J4 --> J5[加载插件]
    end

    J5 --> K[初始化Cron Service]
    K --> L[初始化渠道管理器]

    L --> M{启用的渠道}
    M --> M1[加载WhatsApp]
    M --> M2[加载Telegram]
    M --> M3[加载Discord]
    M --> M4[加载其他...]

    M1 --> N
    M2 --> N
    M3 --> N
    M4 --> N

    N[绑定端口<br/>:18789 / :18790]

    N --> O{绑定成功?}
    O -->|否| P[端口冲突<br/>退出]
    O -->|是| Q[启动成功]

    Q --> R[执行BOOT.md<br/>启动检查]
    R --> S[进入主循环]

    S --> T{事件类型}
    T -->|连接请求| U[处理连接]
    T -->|RPC请求| V[处理RPC]
    T -->|渠道消息| W[处理消息]
    T -->|Cron触发| X[处理定时]
    T -->|信号| Y{信号类型}

    Y -->|SIGTERM| Z[优雅关闭]
    Y -->|SIGUSR1| AA[重载配置]

    U --> S
    V --> S
    W --> S
    X --> S
    AA --> S

    Z --> AB[关闭渠道]
    AB --> AC[关闭连接]
    AC --> AD[保存状态]
    AD --> AE((退出))
```

### 3.2 Agent 执行流程

```mermaid
flowchart TB
    A[接收执行请求] --> B[解析参数]
    B --> C[加载Agent配置]

    C --> D{Agent存在?}
    D -->|否| E[返回错误]
    D -->|是| F[准备执行环境]

    F --> G[加载Session]
    G --> H[构建系统提示]

    subgraph PromptBuild["提示词构建"]
        H --> H1[基础系统提示]
        H1 --> H2[添加身份信息]
        H2 --> H3[添加工具描述]
        H3 --> H4[添加上下文限制]
    end

    H4 --> I[准备历史消息]

    subgraph HistoryPrep["历史准备"]
        I --> I1[加载会话历史]
        I1 --> I2[Token计数]
        I2 --> I3{超过限制?}
        I3 -->|是| I4[裁剪历史]
        I3 -->|否| I5[使用完整历史]
        I4 --> I5
    end

    I5 --> J[记忆检索]

    subgraph MemorySearch["记忆搜索"]
        J --> J1[生成查询嵌入]
        J1 --> J2[向量相似搜索]
        J2 --> J3[获取相关上下文]
    end

    J3 --> K[选择模型]

    subgraph ModelSelect["模型选择"]
        K --> K1{主模型可用?}
        K1 -->|是| K2[使用主模型]
        K1 -->|否| K3{Fallback可用?}
        K3 -->|是| K4[使用Fallback]
        K3 -->|否| K5[返回错误]
    end

    K2 --> L
    K4 --> L

    L[调用Pi Runtime]

    subgraph PiRuntime["Pi Runtime执行"]
        L --> L1[初始化流]
        L1 --> L2[发送请求]
        L2 --> L3[接收Block]

        L3 --> L4{Block类型}
        L4 -->|thinking| L5[处理思考]
        L4 -->|text| L6[处理文本]
        L4 -->|tool_use| L7[处理工具]

        L5 --> L8[广播事件]
        L6 --> L8
        L7 --> L9[执行工具]

        L9 --> L10{工具类型}
        L10 -->|bash| L11[Bash执行]
        L10 -->|browser| L12[浏览器操作]
        L10 -->|file| L13[文件操作]
        L10 -->|web| L14[网络请求]

        L11 --> L15[收集结果]
        L12 --> L15
        L13 --> L15
        L14 --> L15

        L15 --> L16[工具结果注入]
        L16 --> L2

        L8 --> L17{完成?}
        L17 -->|否| L3
        L17 -->|是| L18[最终输出]
    end

    L18 --> M[后处理]
    M --> N[保存到Session]
    N --> O[返回响应]
    O --> P((完成))
```

### 3.3 前端应用生命周期

```mermaid
flowchart TB
    A[页面加载] --> B[main.ts入口]
    B --> C[加载样式]
    C --> D[注册Web Component]

    D --> E[OpenClawApp<br/>connectedCallback]

    subgraph Init["初始化阶段"]
        E --> E1[推断基础路径]
        E1 --> E2[从URL读取设置]
        E2 --> E3[同步标签页状态]
        E3 --> E4[附加主题监听]
    end

    E4 --> F[连接Gateway]

    subgraph Connect["连接阶段"]
        F --> F1[创建WebSocket]
        F1 --> F2[等待Challenge]
        F2 --> F3[设备认证]
        F3 --> F4{认证成功?}
        F4 -->|否| F5[显示错误]
        F4 -->|是| F6[接收Hello]
    end

    F6 --> G[初始数据加载]

    subgraph DataLoad["数据加载"]
        G --> G1[loadAssistantIdentity]
        G --> G2[loadAgents]
        G --> G3[loadNodes]
        G --> G4[refreshActiveTab]
        G --> G5[applySnapshot]
    end

    G5 --> H[启动轮询]

    subgraph Polling["轮询服务"]
        H --> H1[startNodesPolling]
        H --> H2[startLogsPolling]
        H --> H3[startDebugPolling]
    end

    H --> I[进入主循环]

    subgraph MainLoop["主循环"]
        I --> I1{事件类型}
        I1 -->|用户操作| I2[处理用户输入]
        I1 -->|WS事件| I3[处理Gateway事件]
        I1 -->|定时器| I4[处理轮询]

        I2 --> I5[更新状态]
        I3 --> I5
        I4 --> I5

        I5 --> I6[触发render]
        I6 --> I7[Lit更新DOM]
        I7 --> I1
    end

    F5 --> J[重连逻辑]
    J --> J1[指数退避]
    J1 --> F

    subgraph Cleanup["清理阶段"]
        K[disconnectedCallback] --> K1[停止轮询]
        K1 --> K2[关闭WebSocket]
        K2 --> K3[保存状态]
    end
```

---

## 4. 数据流图

### 4.1 消息数据流

```
                              ┌──────────────────┐
                              │    用户消息      │
                              └────────┬─────────┘
                                       │
                                       ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                              渠道适配器层                                     │
│                                                                              │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐           │
│  │WhatsApp │  │Telegram │  │ Discord │  │  Slack  │  │ Others  │           │
│  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘  └────┬────┘           │
│       │            │            │            │            │                 │
│       └────────────┴────────────┼────────────┴────────────┘                 │
│                                 │                                           │
│                                 ▼                                           │
│                    ┌────────────────────────┐                               │
│                    │   消息标准化处理        │                               │
│                    │  • 提取发送者信息       │                               │
│                    │  • 提取消息内容        │                               │
│                    │  • 处理媒体附件        │                               │
│                    └───────────┬────────────┘                               │
└────────────────────────────────┼────────────────────────────────────────────┘
                                 │
                                 ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                              Gateway 处理层                                   │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                        路由和会话处理                                 │    │
│  │                                                                     │    │
│  │   SessionKey: {channel}:{chatType}:{peerId}                        │    │
│  │                                                                     │    │
│  │   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐         │    │
│  │   │ 路由解析    │ ──▶ │ 会话加载    │ ──▶ │ Agent选择   │         │    │
│  │   └─────────────┘     └─────────────┘     └─────────────┘         │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                 │                                           │
└─────────────────────────────────┼───────────────────────────────────────────┘
                                  │
                                  ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                              Agent 执行层                                     │
│                                                                              │
│   输入消息 ──▶ ┌─────────────────────────────────────────────────────┐      │
│               │                  提示词构建                          │      │
│               │  系统提示 + 历史上下文 + 记忆检索 + 当前消息          │      │
│               └───────────────────────┬─────────────────────────────┘      │
│                                       │                                     │
│                                       ▼                                     │
│               ┌─────────────────────────────────────────────────────┐      │
│               │                  AI模型调用                          │      │
│               │  Anthropic / OpenAI / Gemini / Ollama               │      │
│               └───────────────────────┬─────────────────────────────┘      │
│                                       │                                     │
│                          ┌────────────┼────────────┐                       │
│                          │            │            │                       │
│                          ▼            ▼            ▼                       │
│                   ┌──────────┐ ┌──────────┐ ┌──────────┐                  │
│                   │ Thinking │ │   Text   │ │ Tool Use │                  │
│                   └──────────┘ └──────────┘ └────┬─────┘                  │
│                                                   │                        │
│                                          ┌───────▼───────┐                │
│                                          │  工具执行     │                │
│                                          │ Bash/Browser  │                │
│                                          │ /File/Web     │                │
│                                          └───────┬───────┘                │
│                                                  │                         │
│                                                  ▼                         │
│                                          ┌──────────────┐                 │
│                                          │  工具结果    │                 │
│                                          └──────┬───────┘                 │
│                                                 │                          │
│                              ┌──────────────────┘                          │
│                              │                                             │
│                              ▼                                             │
│               ┌─────────────────────────────────────────────────────┐      │
│               │                  最终响应                            │      │
│               └───────────────────────┬─────────────────────────────┘      │
│                                       │                                     │
└───────────────────────────────────────┼─────────────────────────────────────┘
                                        │
                                        ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                              响应处理层                                       │
│                                                                              │
│   ┌─────────────┐     ┌─────────────┐     ┌─────────────┐                   │
│   │ 应用Prefix  │ ──▶ │ 分块处理    │ ──▶ │ 格式转换    │                   │
│   └─────────────┘     └─────────────┘     └─────────────┘                   │
│                                                 │                            │
└─────────────────────────────────────────────────┼────────────────────────────┘
                                                  │
                                                  ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│                              渠道发送层                                       │
│                                                                              │
│       ┌────────────┬────────────┬────────────┬────────────┐                 │
│       │            │            │            │            │                 │
│       ▼            ▼            ▼            ▼            ▼                 │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐           │
│  │WhatsApp │  │Telegram │  │ Discord │  │  Slack  │  │ Others  │           │
│  └─────────┘  └─────────┘  └─────────┘  └─────────┘  └─────────┘           │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                        │
                                        ▼
                              ┌──────────────────┐
                              │    用户收到响应   │
                              └──────────────────┘
```

### 4.2 前端数据流

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户交互层                                      │
│                                                                             │
│   ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐                  │
│   │ 点击导航 │  │ 发送消息 │  │ 修改配置 │  │ 其他操作 │                  │
│   └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘                  │
│        │             │             │             │                         │
└────────┼─────────────┼─────────────┼─────────────┼─────────────────────────┘
         │             │             │             │
         ▼             ▼             ▼             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              事件处理层                                      │
│                                                                             │
│   ┌──────────────────────────────────────────────────────────────────┐     │
│   │                         Event Handlers                            │     │
│   │                                                                   │     │
│   │   setTab()  │  sendChatMessage()  │  updateConfig()  │  ...     │     │
│   └──────────────────────────────┬───────────────────────────────────┘     │
│                                  │                                          │
└──────────────────────────────────┼──────────────────────────────────────────┘
                                   │
         ┌─────────────────────────┼─────────────────────────┐
         │                         │                         │
         ▼                         ▼                         ▼
┌────────────────────┐  ┌────────────────────┐  ┌────────────────────┐
│   状态更新 (同步)   │  │  API调用 (异步)     │  │  本地存储 (持久)   │
│                    │  │                    │  │                    │
│  @state属性直接赋值  │  │  Controllers层调用  │  │  saveSettings()   │
│  this.tab = "chat" │  │  request("chat.send")│ │  localStorage     │
│                    │  │                    │  │                    │
└─────────┬──────────┘  └─────────┬──────────┘  └────────────────────┘
          │                       │
          │                       ▼
          │            ┌────────────────────┐
          │            │  Gateway WebSocket │
          │            │                    │
          │            │  • 发送请求帧      │
          │            │  • 等待响应帧      │
          │            │  • 接收事件帧      │
          │            └─────────┬──────────┘
          │                      │
          │                      ▼
          │            ┌────────────────────┐
          │            │    响应/事件处理    │
          │            │                    │
          │            │  handleGatewayEvent│
          │            │  handleResponse    │
          │            └─────────┬──────────┘
          │                      │
          ▼                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              状态管理层                                      │
│                                                                             │
│   ┌──────────────────────────────────────────────────────────────────┐     │
│   │                      @state 属性集合                              │     │
│   │                                                                   │     │
│   │   connected: boolean        chatMessages: Message[]              │     │
│   │   tab: Tab                  settings: UiSettings                 │     │
│   │   chatSending: boolean      configForm: ConfigForm               │     │
│   │   ...200+ reactive props                                         │     │
│   └──────────────────────────────┬───────────────────────────────────┘     │
│                                  │                                          │
│                          状态变化触发                                        │
│                                  │                                          │
└──────────────────────────────────┼──────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              渲染层                                          │
│                                                                             │
│   ┌──────────────────────────────────────────────────────────────────┐     │
│   │                      Lit Render Cycle                             │     │
│   │                                                                   │     │
│   │   1. render() 被调用                                              │     │
│   │   2. 根据当前状态生成模板                                          │     │
│   │   3. Lit 对比虚拟DOM差异                                          │     │
│   │   4. 最小化DOM更新                                                 │     │
│   └──────────────────────────────┬───────────────────────────────────┘     │
│                                  │                                          │
└──────────────────────────────────┼──────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              视图层                                          │
│                                                                             │
│   ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐  ┌────────┐              │
│   │  Chat  │  │Overview│  │Channels│  │ Config │  │  Logs  │  ...         │
│   └────────┘  └────────┘  └────────┘  └────────┘  └────────┘              │
│                                                                             │
│                              DOM 更新                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
                         ┌──────────────────┐
                         │    用户看到更新   │
                         └──────────────────┘
```

---

## 5. 状态机图

### 5.1 WebSocket 连接状态机

```mermaid
stateDiagram-v2
    [*] --> Disconnected

    Disconnected --> Connecting: connect()

    Connecting --> WaitingChallenge: WebSocket opened

    WaitingChallenge --> Authenticating: challenge received

    Authenticating --> Connected: auth success
    Authenticating --> Error: auth failed

    Connected --> Disconnected: connection closed
    Connected --> Error: error occurred

    Error --> Reconnecting: auto retry
    Error --> Disconnected: max retries

    Reconnecting --> Connecting: backoff complete

    state Connected {
        [*] --> Idle
        Idle --> Processing: request sent
        Processing --> Idle: response received
        Idle --> Idle: event received
    }

    state Reconnecting {
        [*] --> Waiting
        Waiting --> [*]: backoff timer
    }
```

### 5.2 聊天状态机

```mermaid
stateDiagram-v2
    [*] --> Idle

    Idle --> Sending: user sends message

    Sending --> Streaming: server starts response

    Streaming --> Streaming: delta received
    Streaming --> ToolRunning: tool_use received

    ToolRunning --> Streaming: tool_result ready

    Streaming --> Complete: final received

    Complete --> Idle: reset

    Sending --> Error: send failed
    Streaming --> Error: stream error
    ToolRunning --> Error: tool error

    Error --> Idle: user retry

    Idle --> Aborting: user abort
    Streaming --> Aborting: user abort
    ToolRunning --> Aborting: user abort

    Aborting --> Idle: abort confirmed

    state Streaming {
        [*] --> ReceivingText
        ReceivingText --> ReceivingThinking: thinking block
        ReceivingThinking --> ReceivingText: text block
    }

    state ToolRunning {
        [*] --> Executing
        Executing --> WaitingResult
        WaitingResult --> [*]
    }
```

### 5.3 会话生命周期状态机

```mermaid
stateDiagram-v2
    [*] --> New

    New --> Active: first message

    Active --> Active: message exchange
    Active --> Idle: no activity

    Idle --> Active: new message
    Idle --> Expired: idle timeout

    Expired --> Reset: reset triggered
    Reset --> Active: new message

    Active --> Paused: send policy = deny
    Paused --> Active: send policy = allow

    state Active {
        [*] --> Ready
        Ready --> Processing: message received
        Processing --> Responding: agent running
        Responding --> Ready: response sent
    }

    note right of Idle
        Session remains in memory
        but marked as idle
    end note

    note right of Expired
        Daily or idle reset
        based on config
    end note
```

---

## 6. 时序图

### 6.1 完整消息处理时序

```mermaid
sequenceDiagram
    participant User as 用户
    participant Channel as 渠道(WhatsApp)
    participant Gateway as Gateway
    participant Router as 路由器
    participant Session as 会话管理
    participant Agent as Agent引擎
    participant Model as AI模型
    participant Tool as 工具系统

    User->>Channel: 发送消息
    Channel->>Gateway: 入站消息事件
    Gateway->>Router: 路由解析

    Router->>Router: 构建SessionKey
    Router->>Session: 加载会话

    alt 新会话
        Session->>Session: 创建新会话
    else 已有会话
        Session->>Session: 加载历史上下文
    end

    Session-->>Router: 会话数据
    Router-->>Gateway: 路由结果+Agent配置

    Gateway->>Agent: 执行请求

    Agent->>Agent: 构建系统提示
    Agent->>Agent: 准备上下文
    Agent->>Model: 调用AI模型

    loop 流式处理
        Model-->>Agent: Block (thinking/text/tool_use)

        alt thinking块
            Agent->>Gateway: 广播thinking事件
        else text块
            Agent->>Gateway: 广播delta事件
        else tool_use块
            Agent->>Tool: 执行工具
            Tool-->>Agent: 工具结果
            Agent->>Model: 继续处理
        end
    end

    Model-->>Agent: 完成
    Agent-->>Gateway: 最终响应

    Gateway->>Gateway: 应用responsePrefix
    Gateway->>Gateway: 分块处理

    Gateway->>Channel: 发送响应
    Channel->>User: 显示响应

    Gateway->>Session: 保存会话
```

### 6.2 设备配对时序

```mermaid
sequenceDiagram
    participant Device as 新设备
    participant Gateway as Gateway
    participant Admin as 管理员
    participant CLI as CLI工具

    Device->>Gateway: WebSocket连接
    Gateway->>Device: challenge事件

    Device->>Device: 生成设备密钥对
    Device->>Gateway: 发送设备身份

    Gateway->>Gateway: 验证签名
    Gateway->>Gateway: 检查设备未知

    Gateway->>Admin: device.pair.requested事件

    Admin->>CLI: openclaw device approve <id>
    CLI->>Gateway: device.pair.approve

    Gateway->>Gateway: 添加到已知设备
    Gateway->>Gateway: 签发设备令牌

    Gateway->>Device: 配对成功 + 令牌
    Gateway->>Admin: device.pair.resolved事件

    Device->>Device: 存储令牌

    Note over Device,Gateway: 后续连接使用令牌认证
    Device->>Gateway: 携带令牌连接
    Gateway->>Gateway: 验证令牌
    Gateway->>Device: 连接成功
```

### 6.3 配置更新时序

```mermaid
sequenceDiagram
    participant User as 用户
    participant UI as Control UI
    participant Gateway as Gateway
    participant Config as 配置管理
    participant Storage as 文件存储

    User->>UI: 修改配置表单
    UI->>UI: 实时验证
    UI->>UI: 更新本地状态

    User->>UI: 点击保存
    UI->>Gateway: config.set请求

    Gateway->>Config: 验证配置
    Config->>Config: Schema验证
    Config->>Config: 检查Hash一致性

    alt Hash不一致
        Config-->>Gateway: 冲突错误
        Gateway-->>UI: 冲突提示
        UI->>User: 显示冲突对话框
    else Hash一致
        Config->>Storage: 写入config.json
        Storage-->>Config: 写入成功
        Config-->>Gateway: 保存成功
        Gateway-->>UI: 成功响应
    end

    User->>UI: 点击应用
    UI->>Gateway: config.apply请求

    Gateway->>Gateway: 触发重启哨兵

    Note over Gateway: Gateway进程重启

    Gateway->>Gateway: 重新加载配置
    Gateway->>UI: 连接断开 (1012)

    UI->>UI: 开始重连
    UI->>Gateway: 重新连接
    Gateway-->>UI: 连接成功

    UI->>User: 配置已应用
```

---

## 附录：图例说明

### 流程图符号

| 符号 | 含义 |
|------|------|
| ⬜ 矩形 | 处理步骤 |
| ◇ 菱形 | 判断/分支 |
| ⬭ 圆角矩形 | 开始/结束 |
| ▭ 平行四边形 | 输入/输出 |
| → 箭头 | 流程方向 |

### 架构图约定

| 层级 | 颜色/样式 | 说明 |
|------|----------|------|
| 用户层 | 顶部 | 用户和通讯渠道 |
| 网关层 | 中间 | Gateway服务 |
| 服务层 | 中间 | 核心业务服务 |
| 模型层 | 底部 | AI模型提供商 |
| 存储层 | 底部 | 数据持久化 |

---

*文档生成时间: 2026-02-02*
