# OpenClaw 需求分析文档

> 版本: 2026.2.1 | 文档版本: 1.0 | 编写日期: 2026-02-02

---

## 目录

1. [项目概述](#1-项目概述)
2. [项目背景与目标](#2-项目背景与目标)
3. [用户角色与场景](#3-用户角色与场景)
4. [功能性需求](#4-功能性需求)
5. [非功能性需求](#5-非功能性需求)
6. [接口需求](#6-接口需求)
7. [数据需求](#7-数据需求)
8. [约束与假设](#8-约束与假设)
9. [验收标准](#9-验收标准)
10. [附录](#附录)

---

## 1. 项目概述

### 1.1 项目名称

**OpenClaw** - 个人AI助手平台

### 1.2 项目简介

OpenClaw 是一个功能强大的个人AI助手平台，允许用户在自己的设备上部署和运行。它通过统一的网关服务连接多个通讯渠道（WhatsApp、Telegram、Slack、Discord、Signal、iMessage等30+平台），利用先进的AI模型（Anthropic Claude、OpenAI GPT、Google Gemini等）提供智能对话和任务处理能力。

### 1.3 文档目的

本文档旨在完整描述 OpenClaw 项目的所有需求，包括功能需求、非功能需求、接口需求和数据需求，为开发团队提供明确的开发依据，确保项目能够被完整复刻。

### 1.4 术语定义

| 术语 | 定义 |
|------|------|
| Gateway | 核心网关服务，负责消息路由和客户端连接管理 |
| Agent | AI代理，负责处理用户消息并生成响应 |
| Channel | 通讯渠道，如WhatsApp、Telegram等 |
| Session | 会话，代表与特定用户/群组的对话上下文 |
| Tool | 工具，Agent可调用的功能扩展（如执行命令、浏览网页） |
| Skill | 技能，可加载的Agent能力扩展 |
| Node | 节点，远程连接的设备或服务 |

---

## 2. 项目背景与目标

### 2.1 项目背景

#### 2.1.1 市场需求

- 用户需要一个统一的AI助手，能够跨越多个通讯平台工作
- 企业和个人需要在本地部署AI助手以保护数据隐私
- 现有解决方案缺乏灵活的多渠道支持和本地部署选项

#### 2.1.2 技术背景

- 大语言模型（LLM）技术成熟，可提供高质量对话能力
- 各通讯平台提供API或非官方库支持第三方集成
- 现代Web技术支持跨平台客户端开发

### 2.2 项目目标

#### 2.2.1 核心目标

| 目标 | 描述 | 优先级 |
|------|------|--------|
| 多渠道集成 | 支持30+主流通讯平台 | P0 |
| 多模型支持 | 集成主流AI模型提供商 | P0 |
| 本地部署 | 支持用户自托管 | P0 |
| 隐私保护 | 数据存储在本地 | P0 |
| 跨平台客户端 | Web/CLI/macOS/iOS/Android | P1 |
| 可扩展性 | 插件和技能系统 | P1 |

#### 2.2.2 量化目标

| 指标 | 目标值 |
|------|--------|
| 支持渠道数量 | ≥30 |
| 支持AI模型数量 | ≥10 |
| 消息响应延迟 | <5秒（不含AI处理时间） |
| 并发会话数 | ≥1000 |
| 系统可用性 | ≥99.5% |

### 2.3 项目范围

#### 2.3.1 包含范围

- 核心Gateway服务开发
- 30+通讯渠道集成
- 多AI模型集成
- Web控制面板
- CLI工具
- macOS/iOS/Android客户端
- 插件和技能系统
- 文档和部署指南

#### 2.3.2 不包含范围

- 自研AI模型
- 通讯平台官方API（使用现有库）
- 企业级多租户支持
- 商业化付费功能

---

## 3. 用户角色与场景

### 3.1 用户角色定义

#### 3.1.1 终端用户 (End User)

**描述**: 通过通讯渠道与AI助手交互的普通用户

**特征**:
- 可能不了解技术细节
- 通过WhatsApp、Telegram等发送消息
- 期望快速、准确的AI响应

**主要需求**:
- 自然语言对话
- 快速响应
- 多媒体支持（图片、语音、文件）

#### 3.1.2 管理员 (Administrator)

**描述**: 部署和管理OpenClaw实例的技术人员

**特征**:
- 具备技术背景
- 负责系统配置和维护
- 管理渠道连接和用户权限

**主要需求**:
- 简单的部署流程
- 完善的配置管理
- 系统监控和日志
- 安全访问控制

#### 3.1.3 开发者 (Developer)

**描述**: 扩展OpenClaw功能的开发人员

**特征**:
- 熟悉TypeScript/JavaScript
- 需要开发自定义插件或技能
- 可能贡献代码到主项目

**主要需求**:
- 完善的API文档
- 插件开发SDK
- 调试工具

### 3.2 用户场景 (Use Cases)

#### 3.2.1 UC-001: 私聊对话

**参与者**: 终端用户, AI助手

**前置条件**:
- 用户已通过配对或在允许列表中
- AI助手已连接到渠道

**主流程**:
1. 用户通过通讯渠道发送消息
2. 系统接收消息并识别用户
3. 系统验证用户权限
4. 系统加载用户会话上下文
5. AI处理消息并生成响应
6. 系统将响应发送给用户

**替代流程**:
- 4a. 用户未配对: 系统发送配对提示
- 5a. AI调用工具: 执行工具并继续处理
- 6a. 响应过长: 系统分块发送

**后置条件**: 会话状态已更新

---

#### 3.2.2 UC-002: 群组对话

**参与者**: 终端用户(多个), AI助手

**前置条件**:
- AI助手已添加到群组
- 群组策略允许交互

**主流程**:
1. 用户在群组中@提及AI助手
2. 系统检测到提及并接收消息
3. 系统验证发送者权限
4. 系统加载群组会话上下文
5. AI处理消息并生成响应
6. 系统在群组中发送响应

**替代流程**:
- 1a. 未@提及但策略为open: 继续处理
- 3a. 发送者不在允许列表: 忽略消息

**后置条件**: 群组会话状态已更新

---

#### 3.2.3 UC-003: 用户配对

**参与者**: 新用户, 管理员

**前置条件**:
- DM策略设置为pairing模式
- 管理员可访问CLI

**主流程**:
1. 新用户发送消息给AI助手
2. 系统检测到未知用户
3. 系统生成配对码并发送给用户
4. 用户将配对码告知管理员
5. 管理员运行配对批准命令
6. 系统将用户添加到允许列表
7. 用户后续消息正常处理

**后置条件**: 用户已添加到允许列表

---

#### 3.2.4 UC-004: 渠道连接

**参与者**: 管理员

**前置条件**:
- Gateway已启动
- 渠道已配置

**主流程**:
1. 管理员打开控制面板
2. 管理员选择要连接的渠道
3. 系统显示连接方式（扫码/Token等）
4. 管理员完成认证
5. 系统建立渠道连接
6. 系统显示连接成功状态

**替代流程**:
- 4a. 认证失败: 显示错误并允许重试
- 5a. 连接超时: 显示超时错误

**后置条件**: 渠道已连接

---

#### 3.2.5 UC-005: 配置管理

**参与者**: 管理员

**前置条件**:
- 管理员已通过认证
- 有配置写入权限

**主流程**:
1. 管理员打开配置页面
2. 系统显示当前配置
3. 管理员修改配置项
4. 系统实时验证配置有效性
5. 管理员保存配置
6. 管理员应用配置
7. 系统重启并加载新配置

**替代流程**:
- 4a. 配置无效: 显示错误提示
- 5a. 配置冲突: 显示合并选项

**后置条件**: 新配置已生效

---

#### 3.2.6 UC-006: 工具执行

**参与者**: 终端用户, AI助手

**前置条件**:
- 工具已启用
- 用户有执行权限

**主流程**:
1. 用户请求需要工具的操作
2. AI决定调用特定工具
3. 系统检查工具权限
4. 系统执行工具
5. 工具返回结果
6. AI基于结果生成响应
7. 系统将响应发送给用户

**替代流程**:
- 3a. 工具需要批准: 等待管理员批准
- 4a. 工具执行失败: AI处理错误

**后置条件**: 工具执行已记录

---

#### 3.2.7 UC-007: 执行批准

**参与者**: AI助手, 管理员

**前置条件**:
- 工具配置为需要批准
- 管理员可接收批准请求

**主流程**:
1. AI请求执行敏感工具
2. 系统创建批准请求
3. 系统通知管理员
4. 管理员查看请求详情
5. 管理员批准请求
6. 系统执行工具
7. AI继续处理

**替代流程**:
- 5a. 管理员拒绝: AI处理拒绝情况
- 5b. 超时: 自动拒绝

**后置条件**: 批准决策已记录

---

#### 3.2.8 UC-008: 设备配对

**参与者**: 新设备, 管理员

**前置条件**:
- 新设备安装了客户端
- 管理员可访问控制面板

**主流程**:
1. 新设备尝试连接Gateway
2. 系统验证设备签名
3. 系统检测到未知设备
4. 系统创建配对请求
5. 管理员收到配对通知
6. 管理员批准配对
7. 系统为设备签发Token
8. 设备成功连接

**替代流程**:
- 6a. 管理员拒绝: 设备连接被拒绝

**后置条件**: 设备已注册

---

#### 3.2.9 UC-009: 消息发送(出站)

**参与者**: 管理员/系统

**前置条件**:
- 目标渠道已连接
- 有发送权限

**主流程**:
1. 发起发送请求（API/CLI/定时任务）
2. 系统解析目标地址
3. 系统验证发送权限
4. 系统格式化消息
5. 系统通过渠道发送
6. 确认发送成功

**替代流程**:
- 2a. 目标无效: 返回错误
- 5a. 发送失败: 重试或返回错误

**后置条件**: 消息已发送

---

#### 3.2.10 UC-010: 定时任务

**参与者**: 系统, 管理员

**前置条件**:
- Cron任务已配置
- Gateway正在运行

**主流程**:
1. Cron调度器触发任务
2. 系统加载任务配置
3. 系统执行任务（心跳/重置/自定义）
4. 任务完成
5. 系统记录执行结果

**替代流程**:
- 3a. 任务执行失败: 记录错误

**后置条件**: 任务执行已记录

---

## 4. 功能性需求

### 4.1 核心功能模块

#### 4.1.1 FR-100: Gateway 网关服务

##### FR-101: WebSocket服务

| 需求ID | FR-101 |
|--------|--------|
| 需求名称 | WebSocket服务 |
| 优先级 | P0 |
| 描述 | 提供WebSocket服务，支持客户端实时通信 |

**详细要求**:
- FR-101.1: 支持WebSocket协议（RFC 6455）
- FR-101.2: 默认监听端口18789
- FR-101.3: 支持TLS加密连接
- FR-101.4: 支持消息帧协议（请求/响应/事件）
- FR-101.5: 支持心跳检测，超时时间30秒
- FR-101.6: 支持自动重连机制

##### FR-102: HTTP服务

| 需求ID | FR-102 |
|--------|--------|
| 需求名称 | HTTP服务 |
| 优先级 | P0 |
| 描述 | 提供HTTP服务，支持Webhook和API调用 |

**详细要求**:
- FR-102.1: 支持HTTP/1.1和HTTP/2
- FR-102.2: 默认监听端口18790
- FR-102.3: 支持以下端点:
  - `/hooks/*` - Webhook处理
  - `/tools/*` - 工具调用
  - `/openai/*` - OpenAI兼容API
  - `/slack/*` - Slack事件
  - `/control-ui/*` - 控制面板静态资源

##### FR-103: 认证系统

| 需求ID | FR-103 |
|--------|--------|
| 需求名称 | 认证系统 |
| 优先级 | P0 |
| 描述 | 提供多种认证方式 |

**详细要求**:
- FR-103.1: 支持Token认证
  - 配置: `gateway.auth.token` 或 `OPENCLAW_GATEWAY_TOKEN`
  - 使用timing-safe比较防止时序攻击
- FR-103.2: 支持密码认证
  - 配置: `gateway.auth.password` 或 `OPENCLAW_GATEWAY_PASSWORD`
- FR-103.3: 支持设备认证
  - 使用Ed25519签名
  - 支持设备Token签发
- FR-103.4: 支持Tailscale集成
  - 自动验证Tailscale用户身份
- FR-103.5: 本地连接免认证
  - Loopback地址自动通过

##### FR-104: 授权系统

| 需求ID | FR-104 |
|--------|--------|
| 需求名称 | 授权系统 |
| 优先级 | P0 |
| 描述 | 基于作用域的权限控制 |

**详细要求**:
- FR-104.1: 支持以下作用域:
  - `operator.admin` - 完全管理权限
  - `operator.read` - 只读访问
  - `operator.write` - 读写访问
  - `operator.approvals` - 执行批准权限
  - `operator.pairing` - 设备配对权限
- FR-104.2: 方法级别授权检查
- FR-104.3: 事件级别作用域过滤

##### FR-105: RPC方法系统

| 需求ID | FR-105 |
|--------|--------|
| 需求名称 | RPC方法系统 |
| 优先级 | P0 |
| 描述 | 提供完整的RPC方法集 |

**详细要求**:
- FR-105.1: 聊天方法
  - `chat.send` - 发送聊天消息
  - `chat.history` - 获取聊天历史
  - `chat.abort` - 中止运行中的聊天
  - `chat.inject` - 注入assistant消息
- FR-105.2: Agent方法
  - `agent` - 执行代理
  - `agents.list` - 获取代理列表
- FR-105.3: 渠道方法
  - `channels.status` - 获取渠道状态
  - `channels.login` - 登录渠道
  - `channels.logout` - 登出渠道
- FR-105.4: 配置方法
  - `config.get` - 获取配置
  - `config.set` - 保存配置
  - `config.apply` - 应用配置
  - `config.schema` - 获取配置Schema
- FR-105.5: 会话方法
  - `sessions.list` - 列出会话
  - `sessions.patch` - 更新会话
  - `sessions.delete` - 删除会话
- FR-105.6: 设备方法
  - `devices.list` - 列出设备
  - `device.pair.*` - 设备配对
  - `device.token.*` - Token管理
- FR-105.7: 其他方法
  - `send` - 发送消息
  - `cron.*` - 定时任务
  - `logs.tail` - 获取日志
  - `health` - 健康检查
  - `exec.approvals.*` - 执行批准

##### FR-106: 事件广播系统

| 需求ID | FR-106 |
|--------|--------|
| 需求名称 | 事件广播系统 |
| 优先级 | P0 |
| 描述 | 实时事件推送 |

**详细要求**:
- FR-106.1: 支持以下事件类型:
  - `chat` - 聊天状态更新
  - `agent` - Agent事件
  - `presence` - 在线状态
  - `cron` - 定时任务事件
  - `device.pair.*` - 设备配对事件
  - `exec.approval.*` - 执行批准事件
- FR-106.2: 作用域过滤
- FR-106.3: 缓冲区管理（防止慢消费者）
- FR-106.4: 状态版本追踪

---

#### 4.1.2 FR-200: Agent 代理系统

##### FR-201: Agent配置

| 需求ID | FR-201 |
|--------|--------|
| 需求名称 | Agent配置 |
| 优先级 | P0 |
| 描述 | 支持多Agent配置 |

**详细要求**:
- FR-201.1: 支持默认Agent设置
- FR-201.2: 支持多Agent定义
- FR-201.3: Agent配置项:
  - `id` - Agent唯一标识
  - `model` - 主模型配置
  - `fallbackModels` - 备用模型列表
  - `identity` - 身份配置（名称、描述）
  - `workspace` - 工作区路径
  - `groupChat` - 群聊配置
  - `tools` - 工具访问配置

##### FR-202: 模型管理

| 需求ID | FR-202 |
|--------|--------|
| 需求名称 | 模型管理 |
| 优先级 | P0 |
| 描述 | 多AI模型支持 |

**详细要求**:
- FR-202.1: 支持以下模型提供商:
  - Anthropic (Claude)
  - OpenAI (GPT)
  - Google (Gemini)
  - AWS Bedrock
  - Ollama (本地)
  - Qwen
  - Minimax
- FR-202.2: 模型Fallback机制
- FR-202.3: 流式输出支持
- FR-202.4: Token计数和限制

##### FR-203: 提示词系统

| 需求ID | FR-203 |
|--------|--------|
| 需求名称 | 提示词系统 |
| 优先级 | P0 |
| 描述 | 系统提示构建 |

**详细要求**:
- FR-203.1: 基础系统提示模板
- FR-203.2: 身份信息注入
- FR-203.3: 工具描述注入
- FR-203.4: 上下文限制说明
- FR-203.5: 自定义提示支持

##### FR-204: 工具系统

| 需求ID | FR-204 |
|--------|--------|
| 需求名称 | 工具系统 |
| 优先级 | P0 |
| 描述 | Agent可调用的工具集 |

**详细要求**:
- FR-204.1: Bash工具
  - 命令执行
  - 工作目录管理
  - 超时控制
- FR-204.2: 浏览器工具
  - 网页浏览
  - 截图
  - 交互操作
- FR-204.3: 文件工具
  - 文件读取
  - 文件写入
  - 文件编辑
- FR-204.4: Web工具
  - HTTP请求
  - 网页搜索
- FR-204.5: 工具策略
  - 启用/禁用
  - 需要批准
  - 自动允许

##### FR-205: 技能系统

| 需求ID | FR-205 |
|--------|--------|
| 需求名称 | 技能系统 |
| 优先级 | P1 |
| 描述 | 可扩展的技能模块 |

**详细要求**:
- FR-205.1: 技能发现和加载
- FR-205.2: 技能启用/禁用
- FR-205.3: API密钥注入
- FR-205.4: 技能状态查询

##### FR-206: 上下文管理

| 需求ID | FR-206 |
|--------|--------|
| 需求名称 | 上下文管理 |
| 优先级 | P0 |
| 描述 | 对话上下文处理 |

**详细要求**:
- FR-206.1: 历史消息加载
- FR-206.2: Token限制裁剪
- FR-206.3: 记忆检索（向量搜索）
- FR-206.4: 上下文合并

---

#### 4.1.3 FR-300: 渠道系统

##### FR-301: WhatsApp渠道

| 需求ID | FR-301 |
|--------|--------|
| 需求名称 | WhatsApp渠道 |
| 优先级 | P0 |
| 描述 | WhatsApp集成 |

**详细要求**:
- FR-301.1: 使用Baileys库（Web协议）
- FR-301.2: 二维码扫描登录
- FR-301.3: 支持私聊和群组
- FR-301.4: 支持多媒体消息（图片、音频、视频、文档）
- FR-301.5: 支持多账户
- FR-301.6: 消息分块（4000字符限制）
- FR-301.7: 已读回执

##### FR-302: Telegram渠道

| 需求ID | FR-302 |
|--------|--------|
| 需求名称 | Telegram渠道 |
| 优先级 | P0 |
| 描述 | Telegram Bot集成 |

**详细要求**:
- FR-302.1: 使用grammY库
- FR-302.2: Bot Token认证
- FR-302.3: 支持Webhook和轮询模式
- FR-302.4: 支持私聊、群组、频道
- FR-302.5: 支持多媒体消息
- FR-302.6: 支持Markdown格式

##### FR-303: Discord渠道

| 需求ID | FR-303 |
|--------|--------|
| 需求名称 | Discord渠道 |
| 优先级 | P0 |
| 描述 | Discord Bot集成 |

**详细要求**:
- FR-303.1: Bot Token认证
- FR-303.2: 支持服务器和DM
- FR-303.3: 支持@提及触发
- FR-303.4: 支持Embed消息
- FR-303.5: 支持多媒体附件

##### FR-304: Slack渠道

| 需求ID | FR-304 |
|--------|--------|
| 需求名称 | Slack渠道 |
| 优先级 | P0 |
| 描述 | Slack Bot集成 |

**详细要求**:
- FR-304.1: 使用Bolt库
- FR-304.2: OAuth/Token认证
- FR-304.3: Socket Mode支持
- FR-304.4: 支持频道和DM
- FR-304.5: 支持Block Kit消息

##### FR-305: Signal渠道

| 需求ID | FR-305 |
|--------|--------|
| 需求名称 | Signal渠道 |
| 优先级 | P1 |
| 描述 | Signal集成 |

**详细要求**:
- FR-305.1: 使用signal-cli
- FR-305.2: 手机号+密码认证
- FR-305.3: 支持私聊和群组

##### FR-306: iMessage渠道

| 需求ID | FR-306 |
|--------|--------|
| 需求名称 | iMessage渠道 |
| 优先级 | P1 |
| 描述 | iMessage集成（macOS） |

**详细要求**:
- FR-306.1: 仅macOS支持
- FR-306.2: 原生AppleScript/框架集成
- FR-306.3: 支持私聊和群组

##### FR-307: 其他渠道

| 需求ID | FR-307 |
|--------|--------|
| 需求名称 | 其他渠道 |
| 优先级 | P2 |
| 描述 | 更多渠道支持 |

**详细要求**:
- LINE
- Matrix
- Microsoft Teams
- Google Chat
- Mattermost
- Nextcloud Talk
- Twitch
- Nostr
- BlueBubbles
- Zalo
- 等共30+渠道

##### FR-308: 渠道通用功能

| 需求ID | FR-308 |
|--------|--------|
| 需求名称 | 渠道通用功能 |
| 优先级 | P0 |
| 描述 | 所有渠道共享的功能 |

**详细要求**:
- FR-308.1: 统一消息格式
- FR-308.2: 媒体处理管道
- FR-308.3: 消息分块
- FR-308.4: 重试机制
- FR-308.5: 连接状态管理

---

#### 4.1.4 FR-400: 会话管理

##### FR-401: 会话存储

| 需求ID | FR-401 |
|--------|--------|
| 需求名称 | 会话存储 |
| 优先级 | P0 |
| 描述 | 会话数据持久化 |

**详细要求**:
- FR-401.1: JSONL格式存储
- FR-401.2: 会话键格式: `{channel}:{chatType}:{peerId}`
- FR-401.3: 存储路径: `~/.openclaw/state/sessions/`
- FR-401.4: 会话元数据:
  - sessionId
  - updatedAt
  - sendPolicy
  - lastHeartbeatText

##### FR-402: 会话策略

| 需求ID | FR-402 |
|--------|--------|
| 需求名称 | 会话策略 |
| 优先级 | P0 |
| 描述 | 会话管理策略 |

**详细要求**:
- FR-402.1: 作用域模式
  - `per-sender` - 每个发送者独立会话
  - `global` - 全局共享会话
- FR-402.2: 重置模式
  - `daily` - 每日重置
  - `idle` - 空闲超时重置
  - `manual` - 手动重置
- FR-402.3: 历史限制（消息数量）

##### FR-403: DM策略

| 需求ID | FR-403 |
|--------|--------|
| 需求名称 | DM策略 |
| 优先级 | P0 |
| 描述 | 私聊访问控制 |

**详细要求**:
- FR-403.1: `pairing` - 需要配对码
- FR-403.2: `allowlist` - 检查允许列表
- FR-403.3: `open` - 无限制

##### FR-404: 群组策略

| 需求ID | FR-404 |
|--------|--------|
| 需求名称 | 群组策略 |
| 优先级 | P0 |
| 描述 | 群组访问控制 |

**详细要求**:
- FR-404.1: `mention-gating` - 需要@提及
- FR-404.2: `allowlist` - 检查允许列表
- FR-404.3: `open` - 无限制
- FR-404.4: `disabled` - 完全禁用

---

#### 4.1.5 FR-500: 配置管理

##### FR-501: 配置文件

| 需求ID | FR-501 |
|--------|--------|
| 需求名称 | 配置文件 |
| 优先级 | P0 |
| 描述 | 配置文件管理 |

**详细要求**:
- FR-501.1: JSON5格式
- FR-501.2: 默认路径: `~/.openclaw/config.json`
- FR-501.3: 环境变量支持
- FR-501.4: 配置Schema验证

##### FR-502: 配置结构

| 需求ID | FR-502 |
|--------|--------|
| 需求名称 | 配置结构 |
| 优先级 | P0 |
| 描述 | 完整配置结构 |

**详细要求**:
```
config/
├── agents/           # Agent配置
│   ├── default       # 默认Agent
│   └── list[]        # Agent列表
├── channels/         # 渠道配置
│   ├── whatsapp
│   ├── telegram
│   └── ...
├── session/          # 会话配置
│   ├── scope
│   ├── resetMode
│   └── idleTimeout
├── messages/         # 消息配置
│   ├── historyLimit
│   ├── chunkLimit
│   └── responsePrefix
├── gateway/          # 网关配置
│   ├── host
│   ├── port
│   └── auth
├── tools/            # 工具配置
│   ├── policies
│   └── disabled
└── models/           # 模型配置
    └── providers
```

##### FR-503: 配置热重载

| 需求ID | FR-503 |
|--------|--------|
| 需求名称 | 配置热重载 |
| 优先级 | P1 |
| 描述 | 配置变更处理 |

**详细要求**:
- FR-503.1: 文件变化监听
- FR-503.2: SIGUSR1信号触发
- FR-503.3: 优雅重启机制

---

#### 4.1.6 FR-600: 客户端

##### FR-601: Web控制面板

| 需求ID | FR-601 |
|--------|--------|
| 需求名称 | Web控制面板 |
| 优先级 | P0 |
| 描述 | Web管理界面 |

**详细要求**:
- FR-601.1: 技术栈: Lit + Vite
- FR-601.2: 页面列表:
  - Chat - 聊天界面
  - Overview - 概览
  - Channels - 渠道管理
  - Instances - 实例管理
  - Sessions - 会话管理
  - Cron - 定时任务
  - Skills - 技能管理
  - Nodes - 节点管理
  - Config - 配置管理
  - Debug - 调试工具
  - Logs - 日志查看
- FR-601.3: 深色/浅色主题
- FR-601.4: 响应式设计
- FR-601.5: 实时更新（WebSocket）

##### FR-602: CLI工具

| 需求ID | FR-602 |
|--------|--------|
| 需求名称 | CLI工具 |
| 优先级 | P0 |
| 描述 | 命令行工具 |

**详细要求**:
- FR-602.1: 使用Commander.js
- FR-602.2: 主要命令:
  - `openclaw gateway` - 启动网关
  - `openclaw agent` - 执行Agent
  - `openclaw message send` - 发送消息
  - `openclaw pairing` - 配对管理
  - `openclaw config` - 配置管理
  - `openclaw doctor` - 诊断工具
  - `openclaw onboard` - 设置向导

##### FR-603: macOS客户端

| 需求ID | FR-603 |
|--------|--------|
| 需求名称 | macOS客户端 |
| 优先级 | P1 |
| 描述 | macOS原生客户端 |

**详细要求**:
- FR-603.1: Swift开发
- FR-603.2: 菜单栏应用
- FR-603.3: 通知支持
- FR-603.4: 快捷键支持

##### FR-604: iOS客户端

| 需求ID | FR-604 |
|--------|--------|
| 需求名称 | iOS客户端 |
| 优先级 | P1 |
| 描述 | iOS原生客户端 |

**详细要求**:
- FR-604.1: Swift开发
- FR-604.2: 推送通知
- FR-604.3: 快捷指令支持
- FR-604.4: Widget支持

##### FR-605: Android客户端

| 需求ID | FR-605 |
|--------|--------|
| 需求名称 | Android客户端 |
| 优先级 | P1 |
| 描述 | Android原生客户端 |

**详细要求**:
- FR-605.1: Kotlin开发
- FR-605.2: 推送通知
- FR-605.3: 快捷方式支持

---

#### 4.1.7 FR-700: 插件系统

##### FR-701: 插件加载

| 需求ID | FR-701 |
|--------|--------|
| 需求名称 | 插件加载 |
| 优先级 | P1 |
| 描述 | 插件发现和加载 |

**详细要求**:
- FR-701.1: 插件目录扫描
- FR-701.2: 插件清单解析
- FR-701.3: 依赖检查
- FR-701.4: 生命周期管理

##### FR-702: 插件能力

| 需求ID | FR-702 |
|--------|--------|
| 需求名称 | 插件能力 |
| 优先级 | P1 |
| 描述 | 插件可扩展的能力 |

**详细要求**:
- FR-702.1: 自定义工具
- FR-702.2: 自定义渠道
- FR-702.3: 配置Schema扩展
- FR-702.4: HTTP路由扩展
- FR-702.5: 钩子(Hooks)

---

#### 4.1.8 FR-800: 安全功能

##### FR-801: SSRF防护

| 需求ID | FR-801 |
|--------|--------|
| 需求名称 | SSRF防护 |
| 优先级 | P0 |
| 描述 | 服务端请求伪造防护 |

**详细要求**:
- FR-801.1: 私有IP检测（IPv4/IPv6）
- FR-801.2: 受限主机名列表
- FR-801.3: DNS查询拦截
- FR-801.4: 可信IP白名单

##### FR-802: 外部内容处理

| 需求ID | FR-802 |
|--------|--------|
| 需求名称 | 外部内容处理 |
| 优先级 | P0 |
| 描述 | 外部内容安全处理 |

**详细要求**:
- FR-802.1: 注入检测
- FR-802.2: 内容标记和包装
- FR-802.3: 来源标签

##### FR-803: 执行批准

| 需求ID | FR-803 |
|--------|--------|
| 需求名称 | 执行批准 |
| 优先级 | P0 |
| 描述 | 敏感操作批准机制 |

**详细要求**:
- FR-803.1: 批准请求创建
- FR-803.2: 批准请求通知
- FR-803.3: 批准/拒绝处理
- FR-803.4: 超时自动拒绝

---

#### 4.1.9 FR-900: 记忆系统

##### FR-901: 向量嵌入

| 需求ID | FR-901 |
|--------|--------|
| 需求名称 | 向量嵌入 |
| 优先级 | P2 |
| 描述 | 文本嵌入向量生成 |

**详细要求**:
- FR-901.1: OpenAI嵌入
- FR-901.2: Gemini嵌入
- FR-901.3: 本地模型嵌入

##### FR-902: 向量存储

| 需求ID | FR-902 |
|--------|--------|
| 需求名称 | 向量存储 |
| 优先级 | P2 |
| 描述 | 向量数据库 |

**详细要求**:
- FR-902.1: sqlite-vec存储
- FR-902.2: 相似度搜索
- FR-902.3: 混合搜索支持

---

#### 4.1.10 FR-1000: 定时任务

##### FR-1001: Cron调度

| 需求ID | FR-1001 |
|--------|--------|
| 需求名称 | Cron调度 |
| 优先级 | P1 |
| 描述 | 定时任务调度 |

**详细要求**:
- FR-1001.1: Cron表达式支持
- FR-1001.2: 任务类型:
  - 心跳检测
  - 会话重置
  - 自定义任务
- FR-1001.3: 执行日志
- FR-1001.4: 手动触发

---

## 5. 非功能性需求

### 5.1 性能需求

#### NFR-101: 响应时间

| 需求ID | NFR-101 |
|--------|--------|
| 描述 | 系统响应时间要求 |

**详细要求**:
- NFR-101.1: Gateway API响应时间 < 100ms（不含AI处理）
- NFR-101.2: WebSocket消息延迟 < 50ms
- NFR-101.3: 渠道消息转发延迟 < 500ms
- NFR-101.4: 控制面板页面加载 < 2秒

#### NFR-102: 吞吐量

| 需求ID | NFR-102 |
|--------|--------|
| 描述 | 系统吞吐量要求 |

**详细要求**:
- NFR-102.1: 并发WebSocket连接 ≥ 100
- NFR-102.2: 并发会话 ≥ 1000
- NFR-102.3: 消息处理能力 ≥ 100条/秒

#### NFR-103: 资源使用

| 需求ID | NFR-103 |
|--------|--------|
| 描述 | 资源使用限制 |

**详细要求**:
- NFR-103.1: 内存使用 < 2GB（基础运行）
- NFR-103.2: CPU使用 < 50%（空闲时）
- NFR-103.3: 磁盘空间 < 1GB（不含日志和会话）

### 5.2 可用性需求

#### NFR-201: 系统可用性

| 需求ID | NFR-201 |
|--------|--------|
| 描述 | 系统可用性要求 |

**详细要求**:
- NFR-201.1: 目标可用性 ≥ 99.5%
- NFR-201.2: 计划内维护窗口 < 1小时/月
- NFR-201.3: 故障恢复时间 < 5分钟

#### NFR-202: 容错能力

| 需求ID | NFR-202 |
|--------|--------|
| 描述 | 系统容错要求 |

**详细要求**:
- NFR-202.1: AI模型Fallback
- NFR-202.2: 渠道重连机制
- NFR-202.3: WebSocket自动重连
- NFR-202.4: 优雅关闭

### 5.3 安全需求

#### NFR-301: 数据安全

| 需求ID | NFR-301 |
|--------|--------|
| 描述 | 数据安全要求 |

**详细要求**:
- NFR-301.1: 敏感数据本地存储
- NFR-301.2: 凭证加密存储
- NFR-301.3: TLS传输加密
- NFR-301.4: 时序攻击防护

#### NFR-302: 访问控制

| 需求ID | NFR-302 |
|--------|--------|
| 描述 | 访问控制要求 |

**详细要求**:
- NFR-302.1: 多级认证支持
- NFR-302.2: 基于作用域的授权
- NFR-302.3: 设备签名验证
- NFR-302.4: 会话超时

### 5.4 可维护性需求

#### NFR-401: 日志

| 需求ID | NFR-401 |
|--------|--------|
| 描述 | 日志要求 |

**详细要求**:
- NFR-401.1: 结构化日志格式
- NFR-401.2: 日志级别（debug/info/warn/error）
- NFR-401.3: 日志轮转
- NFR-401.4: 实时日志查看

#### NFR-402: 监控

| 需求ID | NFR-402 |
|--------|--------|
| 描述 | 监控要求 |

**详细要求**:
- NFR-402.1: 健康检查端点
- NFR-402.2: 连接状态监控
- NFR-402.3: 渠道状态监控
- NFR-402.4: 性能指标

#### NFR-403: 配置

| 需求ID | NFR-403 |
|--------|--------|
| 描述 | 配置管理要求 |

**详细要求**:
- NFR-403.1: 配置Schema验证
- NFR-403.2: 配置热重载
- NFR-403.3: 环境变量支持
- NFR-403.4: 配置导入/导出

### 5.5 可移植性需求

#### NFR-501: 平台兼容

| 需求ID | NFR-501 |
|--------|--------|
| 描述 | 平台兼容要求 |

**详细要求**:
- NFR-501.1: Linux (Ubuntu, Debian, CentOS)
- NFR-501.2: macOS (10.15+)
- NFR-501.3: Windows (WSL2)
- NFR-501.4: Docker容器

#### NFR-502: Node.js版本

| 需求ID | NFR-502 |
|--------|--------|
| 描述 | Node.js版本要求 |

**详细要求**:
- NFR-502.1: 最低版本: Node.js 22.12.0
- NFR-502.2: 推荐版本: Node.js 22 LTS

### 5.6 可扩展性需求

#### NFR-601: 水平扩展

| 需求ID | NFR-601 |
|--------|--------|
| 描述 | 扩展能力要求 |

**详细要求**:
- NFR-601.1: 插件系统支持功能扩展
- NFR-601.2: 渠道扩展支持
- NFR-601.3: 工具扩展支持
- NFR-601.4: 模型提供商扩展

---

## 6. 接口需求

### 6.1 内部接口

#### 6.1.1 WebSocket协议

**帧格式**:

```typescript
// 请求帧
interface RequestFrame {
  type: "req";
  id: string;           // UUID
  method: string;       // RPC方法名
  params?: unknown;     // 参数
}

// 响应帧
interface ResponseFrame {
  type: "res";
  id: string;
  ok: boolean;
  payload?: unknown;
  error?: {
    code: number;
    message: string;
    details?: unknown;
  };
}

// 事件帧
interface EventFrame {
  type: "event";
  event: string;
  payload?: unknown;
  seq?: number;
  stateVersion?: {
    presence: number;
    health: number;
  };
}
```

#### 6.1.2 RPC方法签名

详见 [FR-105: RPC方法系统](#fr-105-rpc方法系统)

### 6.2 外部接口

#### 6.2.1 AI模型API

| 提供商 | API类型 | 认证方式 |
|--------|---------|----------|
| Anthropic | REST API | API Key |
| OpenAI | REST API | API Key |
| Google Gemini | REST API | API Key |
| AWS Bedrock | AWS SDK | IAM |
| Ollama | REST API | 无 |

#### 6.2.2 通讯平台API

| 平台 | 库/协议 | 认证方式 |
|------|---------|----------|
| WhatsApp | Baileys (Web) | 扫码 |
| Telegram | Bot API | Token |
| Discord | Gateway API | Token |
| Slack | Bolt/Web API | OAuth/Token |
| Signal | signal-cli | 手机号 |

---

## 7. 数据需求

### 7.1 数据实体

#### 7.1.1 Session (会话)

```typescript
interface SessionEntry {
  sessionId: string;
  sessionKey: string;      // {channel}:{chatType}:{peerId}
  updatedAt: number;
  sendPolicy?: "allow" | "deny";
  lastHeartbeatText?: string;
  lastHeartbeatSentAt?: number;
}
```

#### 7.1.2 Agent配置

```typescript
interface AgentConfig {
  id: string;
  model: ModelConfig;
  fallbackModels?: ModelConfig[];
  identity: {
    name: string;
    description?: string;
  };
  workspace?: string;
  groupChat?: {
    systemPrompt?: string;
    historyLimit?: number;
  };
  tools?: {
    policies?: ToolPolicy[];
    disabled?: string[];
  };
}
```

#### 7.1.3 Message (消息)

```typescript
interface Message {
  role: "user" | "assistant" | "system";
  content: ContentBlock[];
  timestamp: number;
  metadata?: {
    channel?: string;
    sender?: string;
    messageId?: string;
  };
}

type ContentBlock =
  | { type: "text"; text: string }
  | { type: "image"; source: ImageSource }
  | { type: "tool_use"; id: string; name: string; input: unknown }
  | { type: "tool_result"; tool_use_id: string; content: unknown };
```

### 7.2 数据存储

#### 7.2.1 文件存储结构

```
~/.openclaw/
├── config.json              # 主配置文件
├── credentials/             # 凭证存储
│   ├── anthropic.json
│   ├── openai.json
│   └── ...
├── state/
│   └── sessions/           # 会话存储
│       ├── main.jsonl
│       └── {sessionKey}.jsonl
├── logs/                    # 日志文件
└── plugins/                 # 插件目录
```

#### 7.2.2 存储格式

| 数据类型 | 格式 | 说明 |
|----------|------|------|
| 配置 | JSON5 | 支持注释 |
| 会话 | JSONL | 每行一条消息 |
| 日志 | 文本 | 结构化日志 |
| 凭证 | JSON | 加密存储 |

### 7.3 数据保留

| 数据类型 | 保留策略 |
|----------|----------|
| 会话 | 根据重置策略 |
| 日志 | 7天轮转 |
| 配置 | 永久 |
| 凭证 | 永久 |

---

## 8. 约束与假设

### 8.1 技术约束

| 约束 | 描述 |
|------|------|
| TC-001 | 必须使用Node.js 22+运行时 |
| TC-002 | 前端必须使用现代浏览器（ES2023支持） |
| TC-003 | WhatsApp集成依赖非官方库（可能不稳定） |
| TC-004 | iMessage仅支持macOS |
| TC-005 | 部分渠道需要Bot账户 |

### 8.2 业务约束

| 约束 | 描述 |
|------|------|
| BC-001 | 不提供多租户支持 |
| BC-002 | 不提供内置付费功能 |
| BC-003 | AI模型调用需要用户自有API密钥 |
| BC-004 | 遵守各通讯平台服务条款 |

### 8.3 假设

| 假设 | 描述 |
|------|------|
| AS-001 | 用户具备基本技术能力 |
| AS-002 | 用户拥有稳定的网络连接 |
| AS-003 | 用户已获取必要的API密钥 |
| AS-004 | 部署环境满足最低配置要求 |

---

## 9. 验收标准

### 9.1 功能验收

| 编号 | 验收标准 | 关联需求 |
|------|----------|----------|
| AC-001 | Gateway能够成功启动并监听指定端口 | FR-101, FR-102 |
| AC-002 | 客户端能够通过WebSocket连接并认证 | FR-103 |
| AC-003 | 能够通过至少3种渠道收发消息 | FR-301~307 |
| AC-004 | AI能够正确响应用户消息 | FR-201~206 |
| AC-005 | 工具调用能够正确执行 | FR-204 |
| AC-006 | 配置修改能够正确保存和应用 | FR-501~503 |
| AC-007 | 控制面板所有页面能够正常访问 | FR-601 |
| AC-008 | CLI所有命令能够正常执行 | FR-602 |

### 9.2 性能验收

| 编号 | 验收标准 | 关联需求 |
|------|----------|----------|
| AC-101 | API响应时间 < 100ms | NFR-101 |
| AC-102 | 支持100并发连接无错误 | NFR-102 |
| AC-103 | 内存使用 < 2GB | NFR-103 |

### 9.3 安全验收

| 编号 | 验收标准 | 关联需求 |
|------|----------|----------|
| AC-201 | 无认证请求被正确拒绝 | FR-103, NFR-302 |
| AC-202 | SSRF测试用例全部通过 | FR-801 |
| AC-203 | 敏感数据未明文存储 | NFR-301 |

---

## 附录

### A. 参考文档

| 文档 | 链接 |
|------|------|
| Baileys文档 | https://github.com/WhiskeySockets/Baileys |
| grammY文档 | https://grammy.dev/ |
| Lit文档 | https://lit.dev/ |
| Anthropic API | https://docs.anthropic.com/ |
| OpenAI API | https://platform.openai.com/docs/ |

### B. 修订历史

| 版本 | 日期 | 作者 | 描述 |
|------|------|------|------|
| 1.0 | 2026-02-02 | - | 初始版本 |

### C. 术语表

| 术语 | 英文 | 定义 |
|------|------|------|
| 网关 | Gateway | 核心服务，负责消息路由和客户端管理 |
| 代理 | Agent | AI处理单元 |
| 渠道 | Channel | 通讯平台 |
| 会话 | Session | 对话上下文 |
| 工具 | Tool | Agent可调用的功能 |
| 技能 | Skill | 可加载的能力扩展 |
| 节点 | Node | 远程连接的设备 |

---

*文档结束*
