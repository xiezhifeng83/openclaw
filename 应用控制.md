# OpenClaw 应用控制机制详解

## 目录

1. [概述](#1-概述)
2. [核心架构](#2-核心架构)
3. [命令执行控制 (Exec Tool)](#3-命令执行控制-exec-tool)
4. [浏览器控制 (Browser Tool)](#4-浏览器控制-browser-tool)
5. [节点设备控制 (Nodes Tool)](#5-节点设备控制-nodes-tool)
6. [剪贴板控制](#6-剪贴板控制)
7. [安全与权限机制](#7-安全与权限机制)
8. [工具调用流程](#8-工具调用流程)
9. [关键代码位置索引](#9-关键代码位置索引)

---

## 1. 概述

OpenClaw 是一个基于 Node.js 的个人 AI 助手系统，通过 **工具系统 (Tools)** 实现对电脑和其他应用程序的全面控制。

### 技术栈

| 组件 | 技术 |
|------|------|
| 运行时 | Node.js ≥ 22 |
| 语言 | TypeScript (ESM) |
| Agent 框架 | Pi RPC Agent (`@mariozechner/pi-agent-core`) |
| 浏览器自动化 | Playwright (`playwright-core`) |
| 终端控制 | PTY (`@lydell/node-pty`) |
| 进程管理 | Node.js `child_process` |

### 控制能力矩阵

| 控制类型 | 实现方式 | 主要工具 |
|----------|----------|----------|
| 命令执行 | Shell/PTY/Docker | `exec` |
| 浏览器操作 | Playwright + CDP | `browser` |
| 设备控制 | Gateway RPC | `nodes` |
| 进程管理 | Process Registry | `process` |
| 文件操作 | Node.js fs | `read`/`write`/`edit` |

---

## 2. 核心架构

### 2.1 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户界面层                               │
│  (Telegram / Discord / Slack / WhatsApp / CLI / Web UI)         │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Gateway 控制平面                           │
│                   WebSocket (ws://127.0.0.1:18789)              │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                        Pi Agent (RPC)                           │
│                    工具策略检查 & 调度执行                        │
└─────────────────────────────────────────────────────────────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        ▼                       ▼                       ▼
┌───────────────┐      ┌───────────────┐      ┌───────────────┐
│   Exec Tool   │      │ Browser Tool  │      │  Nodes Tool   │
│ (命令执行)     │      │ (浏览器控制)   │      │ (设备控制)    │
└───────────────┘      └───────────────┘      └───────────────┘
        │                       │                       │
        ▼                       ▼                       ▼
┌───────────────┐      ┌───────────────┐      ┌───────────────┐
│ • Sandbox     │      │ • Playwright  │      │ • macOS App   │
│ • Gateway     │      │ • CDP         │      │ • iOS App     │
│ • Node        │      │ • Chrome Ext  │      │ • Android App │
└───────────────┘      └───────────────┘      └───────────────┘
```

### 2.2 执行环境

OpenClaw 支持三种执行环境：

| 环境 | 说明 | 安全级别 |
|------|------|----------|
| `sandbox` | Docker 容器隔离执行 | 高 |
| `gateway` | 本地主机直接执行 | 中 |
| `node` | 远程节点执行 | 可配置 |

---

## 3. 命令执行控制 (Exec Tool)

**核心文件**: `src/agents/bash-tools.exec.ts`

### 3.1 功能概述

Exec Tool 是系统中最核心的控制工具，负责在目标环境中执行 Shell 命令。

### 3.2 执行模式

```typescript
type ExecHost = "sandbox" | "gateway" | "node";
type ExecSecurity = "deny" | "allowlist" | "full";
type ExecAsk = "off" | "on-miss" | "always";
```

| 模式 | 说明 |
|------|------|
| `sandbox` | 在 Docker 容器中执行，完全隔离 |
| `gateway` | 在本地主机执行，受安全策略约束 |
| `node` | 在远程节点执行，需要配对设备 |

### 3.3 核心参数

```typescript
const execSchema = Type.Object({
  command: Type.String(),           // Shell 命令
  workdir: Type.Optional(Type.String()),  // 工作目录
  env: Type.Optional(Type.Record(Type.String(), Type.String())),  // 环境变量
  yieldMs: Type.Optional(Type.Number()),  // 后台化等待时间
  background: Type.Optional(Type.Boolean()),  // 立即后台执行
  timeout: Type.Optional(Type.Number()),  // 超时秒数
  pty: Type.Optional(Type.Boolean()),     // 使用伪终端
  elevated: Type.Optional(Type.Boolean()), // 提权执行
  host: Type.Optional(Type.String()),     // 执行环境
  security: Type.Optional(Type.String()), // 安全模式
  ask: Type.Optional(Type.String()),      // 审批模式
  node: Type.Optional(Type.String()),     // 目标节点
});
```

### 3.4 执行流程

```
命令请求
    │
    ▼
┌─────────────────┐
│ 参数验证        │
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 安全策略检查    │
│ (validateHostEnv)│
└─────────────────┘
    │
    ▼
┌─────────────────┐    ┌─────────────────┐
│ 需要审批？      │───▶│ 请求用户审批    │
│ (requiresApproval)│   │ (approval flow) │
└─────────────────┘    └─────────────────┘
    │                          │
    ▼                          ▼
┌─────────────────┐    ┌─────────────────┐
│ 选择执行环境    │    │ 等待审批决定    │
│ sandbox/gateway │    │ allow/deny      │
└─────────────────┘    └─────────────────┘
    │
    ▼
┌─────────────────┐
│ 启动进程        │
│ (runExecProcess)│
└─────────────────┘
    │
    ▼
┌─────────────────┐
│ 流式输出返回    │
│ (onUpdate)      │
└─────────────────┘
```

### 3.5 PTY 支持

通过 `@lydell/node-pty` 提供完整的伪终端支持：

```typescript
// src/agents/bash-tools.exec.ts:477-513
if (opts.usePty) {
  const ptyModule = await import("@lydell/node-pty");
  pty = spawnPty(shell, [...shellArgs, opts.command], {
    cwd: opts.workdir,
    env: opts.env,
    name: process.env.TERM ?? "xterm-256color",
    cols: 120,
    rows: 30,
  });
}
```

**PTY 功能**：
- 支持需要 TTY 的命令行工具
- 光标位置响应 (DSR)
- 键盘输入传递
- 终端颜色和格式

### 3.6 后台任务支持

```typescript
// 后台化机制
const yieldWindow = allowBackground
  ? backgroundRequested
    ? 0  // 立即后台
    : clampNumber(params.yieldMs ?? defaultBackgroundMs, ...)
  : null;

// 超时后自动后台化
if (yieldWindow !== null && yieldWindow > 0) {
  yieldTimer = setTimeout(() => {
    markBackgrounded(run.session);
    resolveRunning();
  }, yieldWindow);
}
```

---

## 4. 浏览器控制 (Browser Tool)

**核心文件**: `src/agents/tools/browser-tool.ts`

### 4.1 功能概述

Browser Tool 通过 Playwright 和 Chrome DevTools Protocol (CDP) 实现完整的浏览器自动化控制。

### 4.2 支持的操作

| 操作类型 | 操作 | 说明 |
|----------|------|------|
| **生命周期** | `status`, `start`, `stop` | 浏览器启动/停止 |
| **标签页** | `tabs`, `open`, `close`, `focus` | 标签页管理 |
| **导航** | `navigate` | 页面导航 |
| **数据采集** | `snapshot`, `screenshot`, `pdf`, `console` | 页面数据获取 |
| **交互** | `act` (click, type, hover, drag, select, press) | 用户交互模拟 |
| **表单** | `upload`, `dialog` | 文件上传和对话框处理 |

### 4.3 浏览器配置文件

| Profile | 说明 |
|---------|------|
| `openclaw` | 独立的托管浏览器实例 |
| `chrome` | 通过 Chrome 扩展连接用户的 Chrome |

### 4.4 核心交互实现

**核心文件**: `src/browser/pw-tools-core.interactions.ts`

#### 4.4.1 点击操作

```typescript
// src/browser/pw-tools-core.interactions.ts:26-61
export async function clickViaPlaywright(opts: {
  cdpUrl: string;
  targetId?: string;
  ref: string;
  doubleClick?: boolean;
  button?: "left" | "right" | "middle";
  modifiers?: Array<"Alt" | "Control" | "ControlOrMeta" | "Meta" | "Shift">;
  timeoutMs?: number;
}): Promise<void> {
  const page = await getPageForTargetId({...});
  const locator = refLocator(page, ref);

  if (opts.doubleClick) {
    await locator.dblclick({ timeout, button, modifiers });
  } else {
    await locator.click({ timeout, button, modifiers });
  }
}
```

#### 4.4.2 文本输入

```typescript
// src/browser/pw-tools-core.interactions.ts:146-175
export async function typeViaPlaywright(opts: {
  cdpUrl: string;
  ref: string;
  text: string;
  submit?: boolean;
  slowly?: boolean;  // 75ms 延迟模拟真人输入
}): Promise<void> {
  const locator = refLocator(page, ref);

  if (opts.slowly) {
    await locator.click({ timeout });
    await locator.type(text, { timeout, delay: 75 });  // 模拟人工输入
  } else {
    await locator.fill(text, { timeout });
  }

  if (opts.submit) {
    await locator.press("Enter", { timeout });
  }
}
```

#### 4.4.3 拖拽操作

```typescript
// src/browser/pw-tools-core.interactions.ts:82-104
export async function dragViaPlaywright(opts: {
  startRef: string;
  endRef: string;
}): Promise<void> {
  await refLocator(page, startRef).dragTo(refLocator(page, endRef), {...});
}
```

#### 4.4.4 等待条件

```typescript
// src/browser/pw-tools-core.interactions.ts:290-342
export async function waitForViaPlaywright(opts: {
  timeMs?: number;           // 等待指定时间
  text?: string;             // 等待文本出现
  textGone?: string;         // 等待文本消失
  selector?: string;         // 等待选择器可见
  url?: string;              // 等待 URL 匹配
  loadState?: "load" | "domcontentloaded" | "networkidle";
  fn?: string;               // 等待 JavaScript 函数返回 true
}): Promise<void>
```

### 4.5 元素定位机制

使用 `ref` 引用系统定位页面元素：

```typescript
// 角色引用 (role-based)
ref: "e12"  // 基于 role+name 生成的引用

// ARIA 引用 (aria-based)
refs: "aria"  // 使用 Playwright aria-ref ids
```

### 4.6 节点代理支持

Browser Tool 支持通过远程节点控制浏览器：

```typescript
// src/agents/tools/browser-tool.ts:116-155
async function callBrowserProxy(params: {
  nodeId: string;
  method: string;
  path: string;
  body?: unknown;
}): Promise<BrowserProxyResult> {
  const payload = await callGatewayTool("node.invoke", {
    nodeId: params.nodeId,
    command: "browser.proxy",
    params: { method, path, body }
  });
  return parsed;
}
```

---

## 5. 节点设备控制 (Nodes Tool)

**核心文件**: `src/agents/tools/nodes-tool.ts`

### 5.1 功能概述

Nodes Tool 通过 Gateway RPC 控制已配对的远程设备，包括 macOS/iOS/Android 应用和远程主机。

### 5.2 支持的操作

| 操作 | 说明 | 参数 |
|------|------|------|
| `status` | 列出所有节点 | - |
| `describe` | 获取节点详情 | `node` |
| `pending` | 查看待配对请求 | - |
| `approve` / `reject` | 处理配对请求 | `requestId` |
| `notify` | 发送系统通知 | `node`, `title`, `body` |
| `camera_snap` | 拍照 | `node`, `facing`, `maxWidth` |
| `camera_clip` | 录制视频 | `node`, `facing`, `duration` |
| `camera_list` | 列出摄像头 | `node` |
| `screen_record` | 屏幕录制 | `node`, `duration`, `fps` |
| `location_get` | 获取位置 | `node`, `desiredAccuracy` |
| `run` | 远程执行命令 | `node`, `command` |

### 5.3 相机控制

```typescript
// src/agents/tools/nodes-tool.ts:166-247
case "camera_snap": {
  const nodeId = await resolveNodeId(gatewayOpts, node);
  const facings: CameraFacing[] = facingRaw === "both"
    ? ["front", "back"]
    : [facingRaw];

  for (const facing of facings) {
    const raw = await callGatewayTool("node.invoke", {
      nodeId,
      command: "camera.snap",
      params: {
        facing,           // 前置/后置
        maxWidth,         // 最大宽度
        quality,          // 压缩质量
        format: "jpg",
        delayMs,          // 拍照延迟
        deviceId,         // 指定摄像头
      },
    });

    // 写入临时文件并返回 Base64 图片
    await writeBase64ToFile(filePath, payload.base64);
    content.push({
      type: "image",
      data: payload.base64,
      mimeType: "image/jpeg",
    });
  }
}
```

### 5.4 屏幕录制

```typescript
// src/agents/tools/nodes-tool.ts:310-354
case "screen_record": {
  const raw = await callGatewayTool("node.invoke", {
    nodeId,
    command: "screen.record",
    params: {
      durationMs,      // 录制时长
      screenIndex,     // 屏幕索引 (多屏幕)
      fps,             // 帧率
      format: "mp4",
      includeAudio,    // 是否包含音频
    },
  });

  const filePath = screenRecordTempPath({ ext: "mp4" });
  await writeScreenRecordToFile(filePath, payload.base64);
  return { content: [{ type: "text", text: `FILE:${filePath}` }] };
}
```

### 5.5 位置服务

```typescript
// src/agents/tools/nodes-tool.ts:356-385
case "location_get": {
  const raw = await callGatewayTool("node.invoke", {
    nodeId,
    command: "location.get",
    params: {
      maxAgeMs,           // 缓存有效期
      desiredAccuracy,    // "coarse" | "balanced" | "precise"
      timeoutMs,          // 定位超时
    },
  });
  return jsonResult(raw?.payload ?? {});
}
```

### 5.6 远程命令执行

```typescript
// src/agents/tools/nodes-tool.ts:386-440
case "run": {
  // 验证节点支持 system.run
  const supportsSystemRun = nodeInfo?.commands?.includes("system.run");

  const raw = await callGatewayTool("node.invoke", {
    nodeId,
    command: "system.run",
    params: {
      command,              // argv 数组
      cwd,                  // 工作目录
      env,                  // 环境变量
      timeoutMs,            // 命令超时
      needsScreenRecording, // 是否需要屏幕录制权限
      agentId,
      sessionKey,
    },
  });
}
```

---

## 6. 剪贴板控制

**核心文件**: `src/infra/clipboard.ts`

### 6.1 跨平台实现

```typescript
// src/infra/clipboard.ts:3-25
export async function copyToClipboard(value: string): Promise<boolean> {
  const attempts: Array<{ argv: string[] }> = [
    { argv: ["pbcopy"] },                    // macOS
    { argv: ["xclip", "-selection", "clipboard"] }, // Linux X11
    { argv: ["wl-copy"] },                   // Linux Wayland
    { argv: ["clip.exe"] },                  // Windows/WSL
    { argv: ["powershell", "-NoProfile", "-Command", "Set-Clipboard"] },
  ];

  for (const attempt of attempts) {
    try {
      const result = await runCommandWithTimeout(attempt.argv, {
        timeoutMs: 3_000,
        input: value,
      });
      if (result.code === 0 && !result.killed) {
        return true;
      }
    } catch {
      // 尝试下一个方案
    }
  }
  return false;
}
```

---

## 7. 安全与权限机制

### 7.1 危险环境变量拦截

**核心文件**: `src/agents/bash-tools.exec.ts:59-107`

```typescript
// 禁止的环境变量 - 可能导致代码注入
const DANGEROUS_HOST_ENV_VARS = new Set([
  "LD_PRELOAD",           // 动态库预加载
  "LD_LIBRARY_PATH",      // 库搜索路径
  "LD_AUDIT",             // 审计库
  "DYLD_INSERT_LIBRARIES",// macOS 动态库注入
  "DYLD_LIBRARY_PATH",    // macOS 库路径
  "NODE_OPTIONS",         // Node.js 启动选项
  "NODE_PATH",            // Node.js 模块路径
  "PYTHONPATH",           // Python 模块路径
  "PYTHONHOME",           // Python 安装路径
  "RUBYLIB",              // Ruby 库路径
  "PERL5LIB",             // Perl 库路径
  "BASH_ENV",             // Bash 环境脚本
  "ENV",                  // Shell 环境脚本
  "GCONV_PATH",           // glibc 转换路径
  "IFS",                  // 字段分隔符
  "SSLKEYLOGFILE",        // SSL 密钥日志
]);

// 验证函数
function validateHostEnv(env: Record<string, string>): void {
  for (const key of Object.keys(env)) {
    if (DANGEROUS_HOST_ENV_VARS.has(key.toUpperCase())) {
      throw new Error(`Security Violation: Environment variable '${key}' is forbidden.`);
    }
    if (key.toUpperCase() === "PATH") {
      throw new Error("Security Violation: Custom 'PATH' variable is forbidden.");
    }
  }
}
```

### 7.2 命令审批系统

**核心文件**: `src/infra/exec-approvals.ts`

#### 7.2.1 审批配置结构

```typescript
type ExecApprovalsFile = {
  version: 1;
  socket?: {
    path?: string;   // Unix socket 路径
    token?: string;  // 认证令牌
  };
  defaults?: {
    security?: ExecSecurity;  // "deny" | "allowlist" | "full"
    ask?: ExecAsk;            // "off" | "on-miss" | "always"
    askFallback?: ExecSecurity;
    autoAllowSkills?: boolean;
  };
  agents?: Record<string, {
    security?: ExecSecurity;
    ask?: ExecAsk;
    allowlist?: ExecAllowlistEntry[];
  }>;
};
```

#### 7.2.2 白名单匹配

```typescript
// 白名单条目
type ExecAllowlistEntry = {
  id?: string;
  pattern: string;           // 路径模式 (支持 glob)
  lastUsedAt?: number;       // 最后使用时间
  lastUsedCommand?: string;  // 最后使用的命令
  lastResolvedPath?: string; // 解析后的路径
};

// 匹配逻辑
function matchAllowlist(
  entries: ExecAllowlistEntry[],
  resolution: CommandResolution | null,
): ExecAllowlistEntry | null {
  for (const entry of entries) {
    if (matchesPattern(entry.pattern, resolution.resolvedPath)) {
      return entry;
    }
  }
  return null;
}
```

#### 7.2.3 安全命令 (Safe Bins)

```typescript
// 默认安全命令列表
const DEFAULT_SAFE_BINS = [
  "jq", "grep", "cut", "sort", "uniq", "head", "tail", "tr", "wc"
];

// 安全命令检查 - 不允许访问文件路径
function isSafeBinUsage(params: {
  argv: string[];
  resolution: CommandResolution | null;
  safeBins: Set<string>;
}): boolean {
  // 检查是否为安全命令
  // 确保参数中没有文件路径
}
```

#### 7.2.4 审批决策流程

```typescript
// 是否需要审批
function requiresExecApproval(params: {
  ask: ExecAsk;
  security: ExecSecurity;
  analysisOk: boolean;
  allowlistSatisfied: boolean;
}): boolean {
  return (
    params.ask === "always" ||
    (params.ask === "on-miss" &&
      params.security === "allowlist" &&
      (!params.analysisOk || !params.allowlistSatisfied))
  );
}

// 审批决策
type ExecApprovalDecision = "allow-once" | "allow-always" | "deny";
```

### 7.3 Shell 命令分析

```typescript
// 分析 Shell 命令结构
function analyzeShellCommand(params: {
  command: string;
  cwd?: string;
  env?: NodeJS.ProcessEnv;
}): ExecCommandAnalysis {
  // 支持管道 (|)
  // 支持链式操作 (&&, ||, ;)
  // 检测不支持的 token (>, <, `, $())
}

// 禁止的 Shell token
const DISALLOWED_PIPELINE_TOKENS = new Set([
  ">", "<", "`", "\n", "\r", "(", ")"
]);
```

### 7.4 Docker 沙箱

```typescript
// 沙箱配置
type BashSandboxConfig = {
  containerName: string;      // 容器名称
  containerWorkdir: string;   // 容器内工作目录
  workspaceDir: string;       // 主机工作目录
  env?: Record<string, string>;
};

// Docker 执行
const { child } = await spawnWithFallback({
  argv: [
    "docker",
    ...buildDockerExecArgs({
      containerName: opts.sandbox.containerName,
      command: opts.command,
      workdir: containerWorkdir,
      env: opts.env,
      tty: opts.usePty,
    }),
  ],
  ...
});
```

---

## 8. 工具调用流程

### 8.1 完整调用链

```
用户消息
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│                   Gateway WebSocket                          │
│                 ws://127.0.0.1:18789                        │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│                      Pi Agent (RPC)                          │
│                   工具调度 & 策略检查                         │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│                  工具策略检查                                │
│                (pi-tools.policy.ts)                         │
│  • 全局策略: tools.allow / tools.deny                        │
│  • 按提供商: tools.byProvider.<provider>.allow               │
│  • 按 Agent: agents.list[].tools.allow                      │
│  • 沙箱策略: agents.defaults.sandbox.tools.allow             │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│                  工具执行前钩子                               │
│             (pi-tools.before-tool-call.ts)                  │
└─────────────────────────────────────────────────────────────┘
    │
    ├─── [exec 工具] ───────────────────────────────────────────┐
    │                                                          │
    │   ┌────────────────────────────────────────────────┐    │
    │   │ 安全验证 (validateHostEnv)                      │    │
    │   │ 审批检查 (requiresExecApproval)                 │    │
    │   │ 环境选择 (sandbox/gateway/node)                │    │
    │   │ 进程启动 (child_process/pty/docker)           │    │
    │   │ 流式输出 (onUpdate)                            │    │
    │   └────────────────────────────────────────────────┘    │
    │                                                          │
    ├─── [browser 工具] ────────────────────────────────────────┐
    │                                                          │
    │   ┌────────────────────────────────────────────────┐    │
    │   │ 浏览器启动检查                                  │    │
    │   │ CDP 连接 (Playwright)                          │    │
    │   │ 页面操作 (click/type/snapshot)                 │    │
    │   │ 结果返回 (JSON/image/text)                     │    │
    │   └────────────────────────────────────────────────┘    │
    │                                                          │
    ├─── [nodes 工具] ──────────────────────────────────────────┐
    │                                                          │
    │   ┌────────────────────────────────────────────────┐    │
    │   │ 节点选择 (resolveNodeId)                       │    │
    │   │ Gateway RPC 调用 (node.invoke)                 │    │
    │   │ 节点命令执行 (camera/screen/notify)           │    │
    │   │ 媒体数据返回 (Base64)                          │    │
    │   └────────────────────────────────────────────────┘    │
    │                                                          │
    ▼
┌─────────────────────────────────────────────────────────────┐
│                  工具结果后处理                               │
│                  (tool-images.ts)                            │
│  • 图片大小限制                                              │
│  • 格式转换                                                  │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
返回给 Agent → 返回给用户
```

### 8.2 进程会话管理

```typescript
// 会话注册表
type ProcessSession = {
  id: string;
  command: string;
  scopeKey?: string;
  sessionKey?: string;
  notifyOnExit: boolean;
  child?: ChildProcess;
  stdin?: SessionStdin;
  pid?: number;
  startedAt: number;
  cwd?: string;
  maxOutputChars: number;
  aggregated: string;
  tail: string;
  exited: boolean;
  exitCode?: number | null;
  exitSignal?: NodeJS.Signals | number | null;
  backgrounded: boolean;
};

// 会话操作
addSession(session);
markBackgrounded(session);
markExited(session, code, signal, status);
appendOutput(session, "stdout", chunk);
```

---

## 9. 关键代码位置索引

| 功能领域 | 文件路径 | 关键行号 |
|----------|----------|----------|
| **命令执行** | `src/agents/bash-tools.exec.ts` | - |
| - 危险环境变量 | | :59-79 |
| - 环境验证 | | :83-107 |
| - 执行参数 Schema | | :195-241 |
| - 进程启动 | | :421-798 |
| - 工具创建 | | :800-1627 |
| **浏览器控制** | `src/agents/tools/browser-tool.ts` | - |
| - 节点代理 | | :116-155 |
| - 工具创建 | | :220-724 |
| **浏览器交互** | `src/browser/pw-tools-core.interactions.ts` | - |
| - 点击 | | :26-61 |
| - 输入 | | :146-175 |
| - 拖拽 | | :82-104 |
| - 等待 | | :290-342 |
| - 截图 | | :344-377 |
| **节点控制** | `src/agents/tools/nodes-tool.ts` | - |
| - 相机拍照 | | :166-247 |
| - 屏幕录制 | | :310-354 |
| - 位置获取 | | :356-385 |
| - 远程执行 | | :386-440 |
| **剪贴板** | `src/infra/clipboard.ts` | :3-25 |
| **审批系统** | `src/infra/exec-approvals.ts` | - |
| - 配置结构 | | :8-57 |
| - 审批解析 | | :286-356 |
| - 白名单匹配 | | :550-572 |
| - 命令分析 | | :801-838 |
| - 审批判断 | | :1238-1250 |
| **工具策略** | `src/agents/pi-tools.policy.ts` | - |
| **工具定义** | `src/agents/pi-tools.ts` | - |
| **所有工具列表** | `src/agents/openclaw-tools.ts` | - |
| **沙箱管理** | `src/agents/sandbox/` | - |

---

## 总结

OpenClaw 通过精心设计的工具系统实现对电脑和应用程序的全面控制：

1. **Exec Tool** - 核心命令执行能力，支持 Shell/PTY/Docker 三种模式
2. **Browser Tool** - 基于 Playwright 的完整浏览器自动化
3. **Nodes Tool** - 远程设备控制（相机/屏幕/位置/通知）
4. **多层安全机制** - 环境变量过滤 + 白名单 + 审批流程 + 沙箱隔离

整个系统在保持强大控制能力的同时，通过多层安全策略确保操作的安全性和可控性。
