# OpenClaw 网关机制详解

## 目录

1. [概述](#1-概述)
2. [架构设计](#2-架构设计)
3. [服务器启动与配置](#3-服务器启动与配置)
4. [WebSocket 协议](#4-websocket-协议)
5. [连接握手流程](#5-连接握手流程)
6. [节点注册与管理](#6-节点注册与管理)
7. [会话管理](#7-会话管理)
8. [认证与授权](#8-认证与授权)
9. [消息路由与广播](#9-消息路由与广播)
10. [心跳与维护](#10-心跳与维护)
11. [HTTP API 端点](#11-http-api-端点)
12. [关键代码位置索引](#12-关键代码位置索引)

---

## 1. 概述

OpenClaw 的网关 (Gateway) 是整个系统的**核心控制平面**，采用基于 WebSocket 的实时双向通信架构，负责连接管理、消息路由、节点调度和会话管理。

### 核心特性

| 特性 | 说明 |
|------|------|
| **协议版本** | Protocol v3 |
| **默认端口** | 18789 |
| **传输协议** | WebSocket + HTTP |
| **消息格式** | JSON |
| **认证方式** | Token / Password / Tailscale / Device Token |

### 核心职责

```
┌─────────────────────────────────────────────────────────────┐
│                      Gateway 职责                            │
├─────────────────────────────────────────────────────────────┤
│  • 客户端连接管理 (Operator / Node)                          │
│  • 消息路由与转发                                            │
│  • 节点注册与调度                                            │
│  • 会话生命周期管理                                          │
│  • 认证与授权                                               │
│  • 事件广播与状态同步                                        │
│  • HTTP API 服务                                            │
│  • 渠道管理 (Telegram/Discord/Slack等)                      │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. 架构设计

### 2.1 系统架构图

```
                              ┌─────────────────┐
                              │   CLI Client    │
                              │   (operator)    │
                              └────────┬────────┘
                                       │
         ┌─────────────────────────────┼─────────────────────────────┐
         │                             │                             │
         ▼                             ▼                             ▼
┌─────────────────┐         ┌─────────────────┐         ┌─────────────────┐
│  Control UI     │         │  Telegram Bot   │         │  iOS/Android    │
│  (operator)     │         │  (operator)     │         │  App (node)     │
└────────┬────────┘         └────────┬────────┘         └────────┬────────┘
         │                           │                           │
         └───────────────────────────┼───────────────────────────┘
                                     │
                                     ▼
                    ┌─────────────────────────────────┐
                    │         Gateway Server          │
                    │      ws://127.0.0.1:18789       │
                    ├─────────────────────────────────┤
                    │  ┌───────────────────────────┐  │
                    │  │    WebSocket Handler      │  │
                    │  │  • Connection Manager     │  │
                    │  │  • Message Router         │  │
                    │  │  • Event Broadcaster      │  │
                    │  └───────────────────────────┘  │
                    │  ┌───────────────────────────┐  │
                    │  │     Node Registry         │  │
                    │  │  • Node Sessions          │  │
                    │  │  • Command Invocation     │  │
                    │  │  • Capability Tracking    │  │
                    │  └───────────────────────────┘  │
                    │  ┌───────────────────────────┐  │
                    │  │    HTTP Server            │  │
                    │  │  • OpenAI API             │  │
                    │  │  • Control UI             │  │
                    │  │  • Hooks                  │  │
                    │  └───────────────────────────┘  │
                    └─────────────────────────────────┘
                                     │
                    ┌────────────────┼────────────────┐
                    ▼                ▼                ▼
            ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
            │ AI Provider │  │   Browser   │  │   Canvas    │
            │ (Claude/    │  │   Control   │  │   Host      │
            │  GPT/etc)   │  │   :18791    │  │   :18793    │
            └─────────────┘  └─────────────┘  └─────────────┘
```

### 2.2 核心组件

| 组件 | 文件位置 | 职责 |
|------|----------|------|
| **Server Entry** | `src/gateway/server.impl.ts` | 服务器启动入口 |
| **WS Connection** | `src/gateway/server/ws-connection.ts` | WebSocket 连接处理 |
| **Message Handler** | `src/gateway/server/ws-connection/message-handler.ts` | 消息处理器 |
| **Node Registry** | `src/gateway/node-registry.ts` | 节点注册表 |
| **Broadcaster** | `src/gateway/server-broadcast.ts` | 事件广播器 |
| **Auth** | `src/gateway/auth.ts` | 认证模块 |
| **Methods** | `src/gateway/server-methods.ts` | 方法处理器路由 |

### 2.3 端口分配

| 服务 | 端口计算 | 默认值 |
|------|----------|--------|
| Gateway WS/HTTP | `gateway.port` | 18789 |
| Browser Control | `gateway.port + 2` | 18791 |
| Canvas Host | `gateway.port + 4` | 18793 |

---

## 3. 服务器启动与配置

**核心文件**: `src/gateway/server.impl.ts:147-590`

### 3.1 启动函数签名

```typescript
export async function startGatewayServer(
  port = 18789,
  opts: GatewayServerOptions = {},
): Promise<GatewayServer>
```

### 3.2 配置选项

```typescript
type GatewayServerOptions = {
  // 绑定地址策略
  bind?: "loopback" | "lan" | "tailnet" | "auto";

  // 高级绑定地址覆盖
  host?: string;

  // Control UI 开关
  controlUiEnabled?: boolean;

  // OpenAI 兼容 API 开关
  openAiChatCompletionsEnabled?: boolean;

  // OpenResponses API 开关
  openResponsesEnabled?: boolean;

  // 认证配置覆盖
  auth?: GatewayAuthConfig;

  // Tailscale 配置覆盖
  tailscale?: GatewayTailscaleConfig;
};
```

### 3.3 启动流程

```
startGatewayServer()
        │
        ▼
┌───────────────────────────┐
│ 1. 配置加载与验证         │
│    • readConfigFileSnapshot│
│    • migrateLegacyConfig   │
│    • applyPluginAutoEnable │
└───────────────────────────┘
        │
        ▼
┌───────────────────────────┐
│ 2. 初始化核心组件         │
│    • startDiagnosticHeartbeat │
│    • initSubagentRegistry  │
│    • loadGatewayPlugins    │
│    • resolveGatewayRuntimeConfig │
│    • loadGatewayTlsRuntime │
└───────────────────────────┘
        │
        ▼
┌───────────────────────────┐
│ 3. 创建运行时状态         │
│    • createGatewayRuntimeState │
│    • HTTP Server 创建      │
│    • WebSocket Server 初始化│
│    • 广播机制设置          │
└───────────────────────────┘
        │
        ▼
┌───────────────────────────┐
│ 4. 启动服务               │
│    • NodeRegistry 创建     │
│    • startGatewayDiscovery │
│    • startGatewayMaintenanceTimers │
│    • attachGatewayWsHandlers │
│    • cron.start()          │
└───────────────────────────┘
        │
        ▼
    服务就绪
```

### 3.4 运行时状态

```typescript
// src/gateway/server-runtime-state.ts
type GatewayRuntimeState = {
  httpServer: http.Server;
  httpServers: http.Server[];
  wss: WebSocketServer;
  clients: Set<GatewayWsClient>;
  broadcast: BroadcastFunction;
  agentRunSeq: { value: number };
  dedupe: Map<string, DedupeEntry>;
  chatRunState: ChatRunState;
  chatRunBuffers: Map<string, string>;
  chatDeltaSentAt: Map<string, number>;
  chatAbortControllers: Map<string, AbortEntry>;
  canvasHost: CanvasHostServer | null;
};
```

---

## 4. WebSocket 协议

**核心文件**: `src/gateway/protocol/schema/frames.ts`

### 4.1 协议版本

```typescript
// src/gateway/protocol/schema.ts
export const PROTOCOL_VERSION = 3;
```

### 4.2 帧类型定义

#### 4.2.1 请求帧 (Request Frame)

```typescript
// 客户端 → 服务器
const RequestFrameSchema = Type.Object({
  type: Type.Literal("req"),
  id: NonEmptyString,        // 请求 ID (用于关联响应)
  method: NonEmptyString,    // 方法名
  params: Type.Optional(Type.Unknown()),  // 参数
});

// 示例
{
  "type": "req",
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "method": "send",
  "params": {
    "text": "Hello, Claude!"
  }
}
```

#### 4.2.2 响应帧 (Response Frame)

```typescript
// 服务器 → 客户端
const ResponseFrameSchema = Type.Object({
  type: Type.Literal("res"),
  id: NonEmptyString,         // 对应请求 ID
  ok: Type.Boolean(),         // 成功标志
  payload: Type.Optional(Type.Unknown()),  // 成功时的载荷
  error: Type.Optional(ErrorShapeSchema),  // 失败时的错误
});

// 成功响应示例
{
  "type": "res",
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "ok": true,
  "payload": { "messageId": "msg_123" }
}

// 错误响应示例
{
  "type": "res",
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "ok": false,
  "error": {
    "code": "INVALID_REQUEST",
    "message": "Missing required parameter: text",
    "retryable": false
  }
}
```

#### 4.2.3 事件帧 (Event Frame)

```typescript
// 服务器 → 客户端 (单播或广播)
const EventFrameSchema = Type.Object({
  type: Type.Literal("event"),
  event: NonEmptyString,      // 事件名
  payload: Type.Optional(Type.Unknown()),  // 事件载荷
  seq: Type.Optional(Type.Integer()),      // 序列号
  stateVersion: Type.Optional(StateVersionSchema),  // 状态版本
});

// 示例
{
  "type": "event",
  "event": "tick",
  "payload": { "ts": 1737264000000 },
  "seq": 42,
  "stateVersion": { "presence": 5, "health": 3 }
}
```

### 4.3 错误结构

```typescript
const ErrorShapeSchema = Type.Object({
  code: NonEmptyString,       // 错误代码
  message: NonEmptyString,    // 错误消息
  details: Type.Optional(Type.Unknown()),  // 详细信息
  retryable: Type.Optional(Type.Boolean()), // 是否可重试
  retryAfterMs: Type.Optional(Type.Integer()),  // 重试等待时间
});
```

### 4.4 标准事件列表

| 事件 | 说明 | 载荷 |
|------|------|------|
| `connect.challenge` | 连接挑战 | `{ nonce, ts }` |
| `tick` | 心跳 | `{ ts }` |
| `shutdown` | 服务器关闭 | `{ reason, restartExpectedMs? }` |
| `presence` | 存在状态更新 | `{ presence: [...] }` |
| `health` | 健康状态更新 | `{ health: {...} }` |
| `agent` | Agent 事件 | `{ sessionKey, state, ... }` |
| `chat` | 聊天消息 | `{ runId, sessionKey, message }` |
| `node.invoke.request` | 节点调用请求 | `{ id, nodeId, command, params }` |
| `exec.approval.requested` | 执行审批请求 | `{ id, command, ... }` |
| `node.pair.requested` | 节点配对请求 | `{ requestId, ... }` |

---

## 5. 连接握手流程

**核心文件**: `src/gateway/server/ws-connection.ts`, `src/gateway/server/ws-connection/message-handler.ts`

### 5.1 握手时序图

```
客户端                                      服务器
   │                                          │
   │────── WebSocket 连接建立 ──────────────▶│
   │                                          │
   │◀────── connect.challenge ────────────────│
   │        { nonce: "xxx", ts: 1737264000 }  │
   │                                          │
   │────── req: connect ─────────────────────▶│
   │       { minProtocol: 3, maxProtocol: 3,  │
   │         client: {...}, auth: {...},      │
   │         device: {...}, ... }             │
   │                                          │
   │        [认证验证]                         │
   │        [协议协商]                         │
   │        [设备签名验证]                     │
   │                                          │
   │◀────── res: hello-ok ────────────────────│
   │        { protocol: 3, server: {...},     │
   │          features: {...}, snapshot: {...},│
   │          auth: { deviceToken: "..." } }  │
   │                                          │
   │◀══════ 连接建立完成 ══════════════════════│
   │                                          │
   │────── req: health ─────────────────────▶│
   │◀────── res: { ... } ─────────────────────│
   │                                          │
```

### 5.2 Connect 请求参数

```typescript
// src/gateway/protocol/schema/frames.ts:20-68
const ConnectParamsSchema = Type.Object({
  // 协议版本范围
  minProtocol: Type.Integer({ minimum: 1 }),
  maxProtocol: Type.Integer({ minimum: 1 }),

  // 客户端信息
  client: Type.Object({
    id: GatewayClientIdSchema,      // "cli" | "ios-node" | "control-ui" | ...
    displayName: Type.Optional(NonEmptyString),
    version: NonEmptyString,        // 版本号
    platform: NonEmptyString,       // "macos" | "ios" | "android" | ...
    deviceFamily: Type.Optional(NonEmptyString),
    modelIdentifier: Type.Optional(NonEmptyString),
    mode: GatewayClientModeSchema,  // "operator" | "node"
    instanceId: Type.Optional(NonEmptyString),
  }),

  // 节点能力 (仅 node 角色)
  caps: Type.Optional(Type.Array(NonEmptyString)),
  commands: Type.Optional(Type.Array(NonEmptyString)),
  permissions: Type.Optional(Type.Record(NonEmptyString, Type.Boolean())),
  pathEnv: Type.Optional(Type.String()),

  // 角色和作用域
  role: Type.Optional(NonEmptyString),
  scopes: Type.Optional(Type.Array(NonEmptyString)),

  // 设备身份 (可选，用于设备认证)
  device: Type.Optional(Type.Object({
    id: NonEmptyString,             // 设备 ID (从公钥派生)
    publicKey: NonEmptyString,      // Ed25519 公钥
    signature: NonEmptyString,      // 签名
    signedAt: Type.Integer(),       // 签名时间戳
    nonce: Type.Optional(NonEmptyString),  // 非本地连接必需
  })),

  // 认证凭证
  auth: Type.Optional(Type.Object({
    token: Type.Optional(Type.String()),
    password: Type.Optional(Type.String()),
  })),

  // 其他
  locale: Type.Optional(Type.String()),
  userAgent: Type.Optional(Type.String()),
});
```

### 5.3 Hello-OK 响应

```typescript
// src/gateway/protocol/schema/frames.ts:70-113
const HelloOkSchema = Type.Object({
  type: Type.Literal("hello-ok"),
  protocol: Type.Integer(),         // 协商后的协议版本

  server: Type.Object({
    version: NonEmptyString,        // 服务器版本
    commit: Type.Optional(NonEmptyString),
    host: Type.Optional(NonEmptyString),
    connId: NonEmptyString,         // 连接 ID
  }),

  features: Type.Object({
    methods: Type.Array(NonEmptyString),  // 支持的方法列表
    events: Type.Array(NonEmptyString),   // 支持的事件列表
  }),

  snapshot: SnapshotSchema,         // 初始状态快照
  canvasHostUrl: Type.Optional(NonEmptyString),

  auth: Type.Optional(Type.Object({
    deviceToken: NonEmptyString,    // 颁发的设备令牌
    role: NonEmptyString,           // 分配的角色
    scopes: Type.Array(NonEmptyString),  // 授权的作用域
    issuedAtMs: Type.Optional(Type.Integer()),
  })),

  policy: Type.Object({
    maxPayload: Type.Integer(),     // 最大载荷大小 (512KB)
    maxBufferedBytes: Type.Integer(), // 最大缓冲区 (1.5MB)
    tickIntervalMs: Type.Integer(), // 心跳间隔 (30s)
  }),
});
```

### 5.4 握手超时

```typescript
// src/gateway/server/ws-connection.ts
const DEFAULT_HANDSHAKE_TIMEOUT_MS = 10_000;  // 10 秒

// 超时处理
const handshakeTimer = setTimeout(() => {
  if (!client) {
    handshakeState = "failed";
    close();
  }
}, handshakeTimeoutMs);
```

---

## 6. 节点注册与管理

**核心文件**: `src/gateway/node-registry.ts`

### 6.1 节点会话结构

```typescript
// src/gateway/node-registry.ts:4-21
type NodeSession = {
  nodeId: string;              // 节点 ID (设备 ID 或客户端 ID)
  connId: string;              // WebSocket 连接 ID
  client: GatewayWsClient;     // WebSocket 客户端引用
  displayName?: string;        // 显示名称
  platform?: string;           // 平台 (macos/ios/android/linux/windows)
  version?: string;            // 客户端版本
  coreVersion?: string;        // 核心库版本
  uiVersion?: string;          // UI 版本
  deviceFamily?: string;       // 设备族 (iPhone/iPad/Mac)
  modelIdentifier?: string;    // 型号标识 (iPhone14,2)
  remoteIp?: string;           // 远程 IP 地址
  caps: string[];              // 能力列表 (camera/screen/canvas)
  commands: string[];          // 命令列表 (camera.snap/screen.record)
  permissions?: Record<string, boolean>;  // 权限映射
  pathEnv?: string;            // PATH 环境变量
  connectedAtMs: number;       // 连接时间戳
};
```

### 6.2 NodeRegistry 类

```typescript
// src/gateway/node-registry.ts:38-209
class NodeRegistry {
  private nodesById = new Map<string, NodeSession>();
  private nodesByConn = new Map<string, string>();
  private pendingInvokes = new Map<string, PendingInvoke>();

  // 注册节点
  register(client: GatewayWsClient, opts: { remoteIp?: string }): NodeSession;

  // 注销节点
  unregister(connId: string): string | null;

  // 列出已连接节点
  listConnected(): NodeSession[];

  // 获取节点
  get(nodeId: string): NodeSession | undefined;

  // 调用节点命令
  invoke(params: NodeInvokeParams): Promise<NodeInvokeResult>;

  // 处理调用结果
  handleInvokeResult(params: NodeInvokeResultParams): boolean;

  // 发送事件到节点
  sendEvent(nodeId: string, event: string, payload?: unknown): boolean;
}
```

### 6.3 节点注册流程

```typescript
// src/gateway/node-registry.ts:43-79
register(client: GatewayWsClient, opts: { remoteIp?: string }) {
  const connect = client.connect;

  // 节点 ID 优先使用设备 ID，否则使用客户端 ID
  const nodeId = connect.device?.id ?? connect.client.id;

  const session: NodeSession = {
    nodeId,
    connId: client.connId,
    client,
    displayName: connect.client.displayName,
    platform: connect.client.platform,
    version: connect.client.version,
    caps: Array.isArray(connect.caps) ? connect.caps : [],
    commands: Array.isArray(connect.commands) ? connect.commands : [],
    permissions: connect.permissions,
    pathEnv: connect.pathEnv,
    connectedAtMs: Date.now(),
  };

  this.nodesById.set(nodeId, session);
  this.nodesByConn.set(client.connId, nodeId);
  return session;
}
```

### 6.4 节点命令调用

```typescript
// src/gateway/node-registry.ts:107-155
async invoke(params: {
  nodeId: string;
  command: string;
  params?: unknown;
  timeoutMs?: number;
  idempotencyKey?: string;
}): Promise<NodeInvokeResult> {
  const node = this.nodesById.get(params.nodeId);
  if (!node) {
    return {
      ok: false,
      error: { code: "NOT_CONNECTED", message: "node not connected" },
    };
  }

  const requestId = randomUUID();
  const payload = {
    id: requestId,
    nodeId: params.nodeId,
    command: params.command,
    paramsJSON: params.params !== undefined
      ? JSON.stringify(params.params)
      : null,
    timeoutMs: params.timeoutMs,
    idempotencyKey: params.idempotencyKey,
  };

  // 发送 node.invoke.request 事件到节点
  const ok = this.sendEventToSession(node, "node.invoke.request", payload);
  if (!ok) {
    return {
      ok: false,
      error: { code: "UNAVAILABLE", message: "failed to send invoke to node" },
    };
  }

  // 等待结果 (默认超时 30 秒)
  const timeoutMs = params.timeoutMs ?? 30_000;
  return await new Promise<NodeInvokeResult>((resolve, reject) => {
    const timer = setTimeout(() => {
      this.pendingInvokes.delete(requestId);
      resolve({
        ok: false,
        error: { code: "TIMEOUT", message: "node invoke timed out" },
      });
    }, timeoutMs);

    this.pendingInvokes.set(requestId, {
      nodeId: params.nodeId,
      command: params.command,
      resolve,
      reject,
      timer,
    });
  });
}
```

### 6.5 节点能力 (Capabilities)

| 能力 | 说明 | 命令示例 |
|------|------|----------|
| `camera` | 相机访问 | `camera.snap`, `camera.clip`, `camera.list` |
| `screen` | 屏幕录制 | `screen.record` |
| `canvas` | Canvas 渲染 | `canvas.navigate`, `canvas.snapshot` |
| `browser` | 浏览器控制 | `browser.proxy` |
| `location` | 位置服务 | `location.get` |
| `notify` | 系统通知 | `system.notify` |
| `run` | 命令执行 | `system.run` |

---

## 7. 会话管理

**核心文件**: `src/gateway/protocol/schema/sessions.ts`, `src/gateway/server-chat.ts`

### 7.1 会话操作方法

| 方法 | 说明 | 权限 |
|------|------|------|
| `sessions.list` | 列出所有会话 | `operator.read` |
| `sessions.preview` | 预览会话详情 | `operator.read` |
| `sessions.resolve` | 解析会话键 | `operator.read` |
| `sessions.patch` | 修改会话配置 | `operator.write` |
| `sessions.reset` | 重置会话 | `operator.write` |
| `sessions.delete` | 删除会话 | `operator.write` |
| `sessions.compact` | 压缩会话历史 | `operator.write` |

### 7.2 会话修改参数

```typescript
// src/gateway/protocol/schema/sessions.ts
const SessionsPatchParamsSchema = Type.Object({
  key: Type.String(),                    // 会话键
  label: Type.Optional(Type.String()),   // 标签
  thinkingLevel: Type.Optional(Type.String()),
  verboseLevel: Type.Optional(Type.String()),
  reasoningLevel: Type.Optional(Type.String()),
  responseUsage: Type.Optional(Type.Union([
    Type.Literal("off"),
    Type.Literal("tokens"),
    Type.Literal("full"),
  ])),
  elevatedLevel: Type.Optional(Type.String()),
  execHost: Type.Optional(Type.String()),
  execSecurity: Type.Optional(Type.String()),
  execAsk: Type.Optional(Type.String()),
  execNode: Type.Optional(Type.String()),
  model: Type.Optional(Type.String()),
  spawnedBy: Type.Optional(Type.String()),
  sendPolicy: Type.Optional(Type.Union([
    Type.Literal("allow"),
    Type.Literal("deny"),
  ])),
  groupActivation: Type.Optional(Type.Union([
    Type.Literal("mention"),
    Type.Literal("always"),
  ])),
});
```

### 7.3 聊天运行状态

```typescript
// src/gateway/server-chat.ts
type ChatRunEntry = {
  sessionKey: string;
  clientRunId: string;
};

type ChatRunState = {
  registry: ChatRunRegistry;
  buffers: Map<string, string>;         // 运行 ID → 累积文本
  deltaSentAt: Map<string, number>;     // 上次发送增量时间
  abortedRuns: Map<string, number>;     // 已中止的运行
  clear: () => void;
};
```

### 7.4 聊天事件流

```typescript
// Agent 输出增量发送 (限流 150ms)
const emitChatDelta = (sessionKey, clientRunId, seq, text) => {
  chatRunState.buffers.set(clientRunId, text);

  const now = Date.now();
  const last = chatRunState.deltaSentAt.get(clientRunId) ?? 0;
  if (now - last < 150) return;  // 限流

  chatRunState.deltaSentAt.set(clientRunId, now);

  const payload = {
    runId: clientRunId,
    sessionKey,
    seq,
    state: "delta",
    message: {
      role: "assistant",
      content: [{ type: "text", text }],
      timestamp: now,
    },
  };

  broadcast("chat", payload, { dropIfSlow: true });
  nodeSendToSession(sessionKey, "chat", payload);
};
```

---

## 8. 认证与授权

**核心文件**: `src/gateway/auth.ts`, `src/gateway/device-auth.ts`

### 8.1 认证模式

```typescript
// src/gateway/auth.ts:199-222
type ResolvedGatewayAuth = {
  mode: "token" | "password";
  token?: string;
  password?: string;
  allowTailscale: boolean;
};

function resolveGatewayAuth(params: {
  authConfig?: GatewayAuthConfig;
  env?: NodeJS.ProcessEnv;
  tailscaleMode?: GatewayTailscaleMode;
}): ResolvedGatewayAuth {
  const token = authConfig.token
    ?? env.OPENCLAW_GATEWAY_TOKEN
    ?? undefined;
  const password = authConfig.password
    ?? env.OPENCLAW_GATEWAY_PASSWORD
    ?? undefined;
  const mode = authConfig.mode ?? (password ? "password" : "token");
  const allowTailscale = authConfig.allowTailscale
    ?? (tailscaleMode === "serve" && mode !== "password");

  return { mode, token, password, allowTailscale };
}
```

### 8.2 认证方法

| 方法 | 说明 | 配置 |
|------|------|------|
| `token` | 令牌认证 | `gateway.auth.token` 或 `OPENCLAW_GATEWAY_TOKEN` |
| `password` | 密码认证 | `gateway.auth.password` 或 `OPENCLAW_GATEWAY_PASSWORD` |
| `tailscale` | Tailscale 身份 | `gateway.auth.allowTailscale: true` |
| `device-token` | 设备令牌 | 配对后颁发 |

### 8.3 认证流程

```typescript
// src/gateway/auth.ts:238-291
async function authorizeGatewayConnect(params: {
  auth: ResolvedGatewayAuth;
  connectAuth?: ConnectAuth;
  req?: IncomingMessage;
  trustedProxies?: string[];
}): Promise<GatewayAuthResult> {
  const localDirect = isLocalDirectRequest(req, trustedProxies);

  // 1. 尝试 Tailscale 认证 (非本地连接)
  if (auth.allowTailscale && !localDirect) {
    const tailscaleCheck = await resolveVerifiedTailscaleUser({ req });
    if (tailscaleCheck.ok) {
      return { ok: true, method: "tailscale", user: tailscaleCheck.user.login };
    }
  }

  // 2. Token 认证
  if (auth.mode === "token") {
    if (!auth.token) return { ok: false, reason: "token_missing_config" };
    if (!connectAuth?.token) return { ok: false, reason: "token_missing" };
    if (!safeEqual(connectAuth.token, auth.token)) {
      return { ok: false, reason: "token_mismatch" };
    }
    return { ok: true, method: "token" };
  }

  // 3. Password 认证
  if (auth.mode === "password") {
    if (!auth.password) return { ok: false, reason: "password_missing_config" };
    if (!connectAuth?.password) return { ok: false, reason: "password_missing" };
    if (!safeEqual(connectAuth.password, auth.password)) {
      return { ok: false, reason: "password_mismatch" };
    }
    return { ok: true, method: "password" };
  }

  return { ok: false, reason: "unauthorized" };
}
```

### 8.4 设备身份验证

```typescript
// src/gateway/server/ws-connection/message-handler.ts:368-567

// 1. 验证设备 ID 是否从公钥派生
const derivedId = deriveDeviceIdFromPublicKey(device.publicKey);
if (derivedId !== device.id) {
  // 拒绝连接
}

// 2. 验证签名时间戳 (10 分钟容差)
const DEVICE_SIGNATURE_SKEW_MS = 10 * 60 * 1000;
if (Math.abs(Date.now() - signedAt) > DEVICE_SIGNATURE_SKEW_MS) {
  // 签名过期
}

// 3. 验证 Nonce (非本地连接必需)
if (!isLocalClient && !providedNonce) {
  // 需要 nonce
}
if (providedNonce && providedNonce !== connectNonce) {
  // nonce 不匹配
}

// 4. 验证签名
const payload = buildDeviceAuthPayload({
  deviceId: device.id,
  clientId: connectParams.client.id,
  clientMode: connectParams.client.mode,
  role,
  scopes: requestedScopes,
  signedAtMs: signedAt,
  token: connectParams.auth?.token ?? null,
  nonce: providedNonce || undefined,
  version: providedNonce ? "v2" : "v1",
});

const signatureOk = verifyDeviceSignature(
  device.publicKey,
  payload,
  device.signature
);
```

### 8.5 角色与作用域

```typescript
// src/gateway/server-methods.ts:29-50

// 角色
type Role = "operator" | "node";

// 操作员作用域
const OPERATOR_SCOPES = [
  "operator.read",      // 读取权限
  "operator.write",     // 写入权限
  "operator.admin",     // 管理员权限
  "operator.approvals", // 执行审批权限
  "operator.pairing",   // 配对管理权限
];

// 方法授权分类
const NODE_ROLE_METHODS = ["node.invoke.result", "node.event", "skills.bins"];
const APPROVAL_METHODS = ["exec.approval.request", "exec.approval.resolve"];
const PAIRING_METHODS = [
  "node.pair.request", "node.pair.list", "node.pair.approve", "node.pair.reject",
  "device.pair.list", "device.pair.approve", "device.pair.reject",
  "device.token.rotate", "device.token.revoke", "node.rename",
];
const READ_METHODS = ["health", "status", "sessions.list", "node.list", ...];
const WRITE_METHODS = ["send", "agent", "chat.send", "node.invoke", ...];
```

---

## 9. 消息路由与广播

**核心文件**: `src/gateway/server-broadcast.ts`, `src/gateway/server-methods.ts`

### 9.1 广播器实现

```typescript
// src/gateway/server-broadcast.ts:34-88
function createGatewayBroadcaster(params: { clients: Set<GatewayWsClient> }) {
  let seq = 0;

  const broadcast = (
    event: string,
    payload: unknown,
    opts?: {
      dropIfSlow?: boolean;
      stateVersion?: { presence?: number; health?: number };
    },
  ) => {
    const eventSeq = ++seq;
    const frame = JSON.stringify({
      type: "event",
      event,
      payload,
      seq: eventSeq,
      stateVersion: opts?.stateVersion,
    });

    for (const c of params.clients) {
      // 检查作用域权限
      if (!hasEventScope(c, event)) continue;

      // 检查缓冲区大小
      const slow = c.socket.bufferedAmount > MAX_BUFFERED_BYTES;

      // 慢消费者处理
      if (slow && opts?.dropIfSlow) {
        continue;  // 丢弃事件
      }
      if (slow) {
        c.socket.close(1008, "slow consumer");
        continue;
      }

      c.socket.send(frame);
    }
  };

  return { broadcast };
}
```

### 9.2 事件作用域守卫

```typescript
// src/gateway/server-broadcast.ts:9-32
const EVENT_SCOPE_GUARDS: Record<string, string[]> = {
  "exec.approval.requested": ["operator.approvals"],
  "exec.approval.resolved": ["operator.approvals"],
  "device.pair.requested": ["operator.pairing"],
  "device.pair.resolved": ["operator.pairing"],
  "node.pair.requested": ["operator.pairing"],
  "node.pair.resolved": ["operator.pairing"],
};

function hasEventScope(client: GatewayWsClient, event: string): boolean {
  const required = EVENT_SCOPE_GUARDS[event];
  if (!required) return true;  // 无守卫，允许所有

  const role = client.connect.role ?? "operator";
  if (role !== "operator") return false;

  const scopes = client.connect.scopes ?? [];
  if (scopes.includes("operator.admin")) return true;  // 管理员权限

  return required.some(scope => scopes.includes(scope));
}
```

### 9.3 方法路由

```typescript
// src/gateway/server-methods.ts
const coreGatewayHandlers: GatewayMethodHandlers = {
  // 健康检查
  "health": async ({ respond, context }) => { ... },

  // 消息发送
  "send": async ({ params, respond, context }) => { ... },

  // Agent 调用
  "agent": async ({ params, respond, context }) => { ... },

  // 会话操作
  "sessions.list": async ({ respond }) => { ... },
  "sessions.patch": async ({ params, respond }) => { ... },

  // 节点操作
  "node.list": async ({ respond, context }) => { ... },
  "node.invoke": async ({ params, respond, context }) => { ... },
  "node.invoke.result": async ({ params, respond, context }) => { ... },

  // ... 更多方法
};
```

### 9.4 慢消费者保护

| 常量 | 值 | 说明 |
|------|-----|------|
| `MAX_PAYLOAD_BYTES` | 512 KB | 入站帧大小限制 |
| `MAX_BUFFERED_BYTES` | 1.5 MB | 发送缓冲区限制 |

```typescript
// 慢消费者检测
const slow = client.socket.bufferedAmount > MAX_BUFFERED_BYTES;

// 处理策略
if (slow && opts?.dropIfSlow) {
  continue;  // 丢弃非关键事件
}
if (slow) {
  client.socket.close(1008, "slow consumer");  // 关闭连接
}
```

---

## 10. 心跳与维护

**核心文件**: `src/gateway/server-maintenance.ts`

### 10.1 维护定时器

```typescript
// src/gateway/server-maintenance.ts:14-120

// Tick 心跳 (30 秒)
const TICK_INTERVAL_MS = 30_000;
const tickInterval = setInterval(() => {
  const payload = { ts: Date.now() };
  broadcast("tick", payload, { dropIfSlow: true });
  nodeSendToAllSubscribed("tick", payload);
}, TICK_INTERVAL_MS);

// 健康刷新 (60 秒)
const HEALTH_REFRESH_INTERVAL_MS = 60_000;
const healthInterval = setInterval(() => {
  void refreshGatewayHealthSnapshot({ probe: true });
}, HEALTH_REFRESH_INTERVAL_MS);

// 去重缓存清理 (60 秒)
const dedupeCleanup = setInterval(() => {
  const now = Date.now();

  // 清理过期条目
  for (const [k, v] of dedupe) {
    if (now - v.ts > DEDUPE_TTL_MS) {
      dedupe.delete(k);
    }
  }

  // 限制缓存大小
  if (dedupe.size > DEDUPE_MAX) {
    const sorted = [...dedupe.entries()]
      .sort((a, b) => a[1].ts - b[1].ts);
    for (let i = 0; i < dedupe.size - DEDUPE_MAX; i++) {
      dedupe.delete(sorted[i][0]);
    }
  }

  // 清理超时的聊天中止控制器
  for (const [runId, entry] of chatAbortControllers) {
    if (now > entry.expiresAtMs) {
      abortChatRunById({ runId, sessionKey: entry.sessionKey, stopReason: "timeout" });
    }
  }

  // 清理已中止运行的缓冲区
  const ABORTED_RUN_TTL_MS = 60 * 60_000;  // 1 小时
  for (const [runId, abortedAt] of chatRunState.abortedRuns) {
    if (now - abortedAt > ABORTED_RUN_TTL_MS) {
      chatRunState.abortedRuns.delete(runId);
      chatRunBuffers.delete(runId);
    }
  }
}, 60_000);
```

### 10.2 关键常量

| 常量 | 值 | 说明 |
|------|-----|------|
| `TICK_INTERVAL_MS` | 30,000 | 心跳间隔 |
| `HEALTH_REFRESH_INTERVAL_MS` | 60,000 | 健康刷新间隔 |
| `DEDUPE_TTL_MS` | 300,000 | 去重缓存 TTL (5分钟) |
| `DEDUPE_MAX` | 1,000 | 去重缓存最大条目 |
| `DEVICE_SIGNATURE_SKEW_MS` | 600,000 | 签名时间偏移容差 (10分钟) |
| `DEFAULT_HANDSHAKE_TIMEOUT_MS` | 10,000 | 握手超时 |

### 10.3 优雅关闭

```typescript
// src/gateway/server-close.ts
async function closeGateway(opts?: { reason?: string; restartExpectedMs?: number }) {
  // 1. 广播 shutdown 事件
  broadcast("shutdown", {
    reason: opts?.reason ?? "server shutdown",
    restartExpectedMs: opts?.restartExpectedMs,
  });

  // 2. 停止定时器
  clearInterval(tickInterval);
  clearInterval(healthInterval);
  clearInterval(dedupeCleanup);

  // 3. 停止渠道服务
  await channelManager.stopAll();

  // 4. 停止插件服务
  await pluginServices?.stop();

  // 5. 停止定时任务
  cron.stop();

  // 6. 停止心跳运行器
  stopHeartbeatRunner();

  // 7. 关闭 WebSocket 服务器
  wss.close();

  // 8. 关闭 HTTP 服务器
  for (const server of httpServers) {
    server.close();
  }

  // 9. 停止服务发现
  stopGatewayDiscovery();

  // 10. 清理 Tailscale
  await cleanupTailscale();
}
```

---

## 11. HTTP API 端点

### 11.1 端点列表

| 端点 | 方法 | 说明 | 配置 |
|------|------|------|------|
| `/` | GET | Control UI | `gateway.controlUi.enabled` |
| `/v1/chat/completions` | POST | OpenAI 兼容 API | `gateway.http.endpoints.chatCompletions.enabled` |
| `/v1/responses` | POST | OpenResponses API | `gateway.http.endpoints.responses.enabled` |
| `/tools/invoke` | POST | 工具调用 API | - |
| `/hooks/*` | POST | Webhook 处理 | `gateway.hooks.enabled` |
| `/slack/*` | POST | Slack 事件 | Slack 渠道启用时 |
| `/__openclaw__/canvas/*` | * | Canvas Host | `canvasHost.enabled` |

### 11.2 OpenAI 兼容 API

```typescript
// POST /v1/chat/completions
// 处理器: src/gateway/openai-http.ts

// 请求格式 (OpenAI 标准)
{
  "model": "gpt-4",
  "messages": [
    { "role": "user", "content": "Hello!" }
  ],
  "stream": true
}

// 响应格式 (Server-Sent Events)
data: {"id":"chatcmpl-xxx","choices":[{"delta":{"content":"Hi"}}]}
data: {"id":"chatcmpl-xxx","choices":[{"delta":{"content":"!"}}]}
data: [DONE]
```

### 11.3 Webhook 处理

```typescript
// POST /hooks/wake
// 认证: Bearer token 或 X-OpenClaw-Token 头

// 请求
{
  "text": "Wake up message"
}

// 响应
{
  "ok": true,
  "messageId": "msg_xxx"
}
```

---

## 12. 关键代码位置索引

| 功能模块 | 文件路径 | 关键行号 |
|----------|----------|----------|
| **服务器入口** | `src/gateway/server.impl.ts` | - |
| - 启动函数 | | :147-590 |
| - 配置选项 | | :96-145 |
| **WebSocket 连接** | `src/gateway/server/ws-connection.ts` | - |
| - 连接处理器 | | :19-266 |
| - 握手超时 | | :218-228 |
| **消息处理** | `src/gateway/server/ws-connection/message-handler.ts` | - |
| - Connect 处理 | | :264-899 |
| - 设备验证 | | :368-567 |
| **协议定义** | `src/gateway/protocol/schema/frames.ts` | - |
| - 请求帧 | | :126-134 |
| - 响应帧 | | :136-145 |
| - 事件帧 | | :147-156 |
| - Connect 参数 | | :20-68 |
| - Hello-OK | | :70-113 |
| **节点注册** | `src/gateway/node-registry.ts` | - |
| - NodeSession 类型 | | :4-21 |
| - register | | :43-79 |
| - unregister | | :81-97 |
| - invoke | | :107-155 |
| - handleInvokeResult | | :157-181 |
| **认证模块** | `src/gateway/auth.ts` | - |
| - resolveGatewayAuth | | :199-222 |
| - authorizeGatewayConnect | | :238-291 |
| - isLocalDirectRequest | | :107-128 |
| **广播机制** | `src/gateway/server-broadcast.ts` | - |
| - createGatewayBroadcaster | | :34-88 |
| - 事件作用域守卫 | | :9-32 |
| **维护定时器** | `src/gateway/server-maintenance.ts` | - |
| - startGatewayMaintenanceTimers | | :14-120 |
| **方法路由** | `src/gateway/server-methods.ts` | - |
| - coreGatewayHandlers | | :全文件 |
| **节点方法** | `src/gateway/server-methods/nodes.ts` | - |
| - node.invoke | | :197-261 |
| - node.invoke.result | | :263-290 |
| **会话方法** | `src/gateway/server-methods/sessions.ts` | - |
| **聊天状态** | `src/gateway/server-chat.ts` | - |
| - createAgentEventHandler | | :140-231 |

---

## 总结

OpenClaw 的网关是一个功能完整、设计精良的 WebSocket 服务器：

### 核心设计原则

1. **统一协议** - 使用单一 WebSocket 协议处理所有操作员和节点连接
2. **强认证** - 多种认证模式：令牌、密码、Tailscale 身份、设备证书
3. **细粒度授权** - 基于角色和作用域的权限控制
4. **高可靠性** - 完善的心跳、超时和错误处理机制
5. **可扩展性** - 插件系统和渠道管理支持多种集成
6. **安全性** - 设备配对、签名验证、慢消费者保护

### 技术亮点

- **协议版本协商** - 支持向前兼容的协议升级
- **设备身份验证** - Ed25519 签名 + Nonce 防重放
- **慢消费者保护** - 缓冲区监控 + 事件丢弃/断开
- **状态版本同步** - Presence/Health 版本号追踪
- **优雅关闭** - 广播 shutdown 事件 + 有序清理

### 性能参数

| 参数 | 默认值 |
|------|--------|
| 最大载荷 | 512 KB |
| 最大缓冲区 | 1.5 MB |
| 心跳间隔 | 30 秒 |
| 握手超时 | 10 秒 |
| 节点调用超时 | 30 秒 |
